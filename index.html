<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget – PWA (Revenus, Projection, Boussole & Épargnes)</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest?v=5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    :root { --bg:#f6f7fb; --card:#fff; --ink:#0f172a; --muted:#667085; --ring:#e5e7eb; --accent:#2563eb; --good:#16a34a; --warn:#f59e0b; --bad:#ef4444; --bar:#22c55e; --bar2:#3b82f6; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--ink); background:var(--bg) }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px }
    .topnav{ position:sticky; top:0; background:rgba(246,247,251,.8); backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid var(--ring); display:flex; gap:8px; padding:10px 16px; z-index:9 }
    .tab{ padding:10px 14px; border-radius:999px; border:1px solid var(--ring); background:#fff; cursor:pointer; }
    .tab.active{ background:var(--accent); color:#fff; border-color:var(--accent) }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px }
    @media(min-width:1100px){ .grid{ grid-template-columns:1.25fr .75fr } }
    .card{ background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.04) }
    h1{ margin:8px 0 12px } h2{ margin:0 0 10px; font-size:18px }
    input,select,button{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--ring); font-size:16px; background:#fff }
    button{ border:none; background:var(--accent); color:#fff; cursor:pointer }
    .row{ display:flex; gap:8px; flex-wrap:wrap } .row>*{ flex:1 }
    .muted{ color:var(--muted); font-size:14px }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#4338ca; font-size:12px }
    .table{ width:100%; border-collapse: collapse } .table th,.table td{ padding:8px; border-bottom:1px dashed #e5e7eb; text-align:left; vertical-align:top }
    .right{ text-align:right }
    .bar{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden }
    .bar>i{ display:block; height:100%; background:var(--bar); width:0% }
    .bar.blue>i{ background:var(--bar2) }
    .good{ color:var(--good) } .warn{ color:var(--warn) } .bad{ color:var(--bad) }
    .hint{ padding:10px; border-radius:12px; background:#f8fafc; border:1px dashed #e2e8f0; font-size:14px }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .danger{ background:var(--bad) }
    .ghost{ background:#111827; color:#fff }
    .hide{ display:none !important }
    .goal-ok{ color:#fff; background:var(--good); padding:2px 8px; border-radius:999px; font-size:12px }
    .goal-warn{ color:#fff; background:var(--warn); padding:2px 8px; border-radius:999px; font-size:12px }
  </style>
</head>
<body>
  <div class="topnav">
    <button class="tab active" id="tabBudget">Budget</button>
    <button class="tab" id="tabSavings">Épargnes</button>
  </div>

  <div class="wrap">
    <h1>Budget (PWA) — Revenus, Projection & Boussole</h1>
    <p class="muted">Ajoute cette app à l’écran d’accueil (Safari → Partager → “Ajouter à l’écran d’accueil”). Les données sont stockées en local.</p>

    <!-- PAGE BUDGET -->
    <section id="pageBudget">
      <div class="grid">
        <!-- Colonne gauche -->
        <div class="grid-col">

          <div class="card">
            <h2>1) Salaire de base</h2>
            <div class="row">
              <input id="salary" type="number" inputmode="decimal" placeholder="Salaire mensuel (DZD)" />
              <button id="saveSalary">Enregistrer</button>
            </div>
            <p class="muted">Salaire actuel : <strong id="currentSalary">—</strong></p>
          </div>

          <div class="card">
            <h2>2) Autres rentrées d’argent (mois en cours)</h2>
            <div class="row">
              <input id="incAmount" type="number" inputmode="decimal" placeholder="Montant (DZD)" />
              <input id="incDate" type="date" />
            </div>
            <div class="row">
              <input id="incNote" placeholder="Note (ex: freelance, prime, remboursement…)" />
              <button id="addIncome">Ajouter rentrée</button>
            </div>
            <table class="table">
              <thead><tr><th>Date</th><th>Note</th><th class="right">Montant</th><th></th></tr></thead>
              <tbody id="incBody"></tbody>
            </table>
            <p><span class="pill">Total autres revenus (mois) : <span id="incTotal">0</span> DZD</span></p>
          </div>

          <div class="card">
            <h2>3) Enveloppes de dépenses</h2>
            <div class="row">
              <input id="catName" placeholder="Nom (ex: Courses, Véhicule, Scolaire)" />
              <input id="catBudget" type="number" inputmode="decimal" placeholder="Budget (DZD)" />
              <button id="addCat">Ajouter</button>
            </div>
            <table class="table">
              <thead><tr><th>Catégorie</th><th class="right">Budget</th><th></th></tr></thead>
              <tbody id="catsBody"></tbody>
            </table>
            <p><span class="pill">Total catégories : <span id="catsTotal">0</span> DZD</span></p>
          </div>

          <div class="card">
            <h2>4) Dépenses</h2>
            <div class="row">
              <select id="txCat"></select>
              <input id="txAmount" type="number" inputmode="decimal" placeholder="Montant (DZD)" />
            </div>
            <div class="row">
              <input id="txNote" placeholder="Note (facultatif)" />
              <input id="txDate" type="date" />
            </div>
            <div class="row">
              <button id="addTx">Ajouter dépense</button>
              <button id="clearTx" class="danger">Vider l'historique</button>
            </div>
            <table class="table">
              <thead><tr><th>Date</th><th>Catégorie</th><th>Note</th><th class="right">Montant</th></tr></thead>
              <tbody id="txBody"></tbody>
            </table>
          </div>

        </div>

        <!-- Colonne droite -->
        <div class="grid-col">
          <div class="card">
            <h2>Dashboard & Boussole</h2>
            <p class="muted" id="nowMonthTag"></p>
            <p>Revenu du mois (salaire + autres) : <strong id="dashIncome">—</strong></p>
            <p>Salaire de base : <strong id="dashSalary">—</strong></p>
            <p>Autres revenus (mois) : <strong id="dashIncOther">—</strong></p>
            <p>Total budgets (dépenses) : <strong id="dashCats">—</strong></p>
            <p>Total dépensé (mois) : <strong id="dashSpent">—</strong></p>
            <p>Épargne théorique (Revenu − Dépenses) : <strong id="dashSave">—</strong></p>
            <p>Épargne allouée (soldes épargnes) : <strong id="dashSavings">—</strong></p>
            <p>Reste à allouer : <strong id="dashLeft">—</strong></p>
            <div class="bar"><i id="barSpent"></i></div>
            <p class="muted">% dépensé vs revenu du mois.</p>
            <div class="hint" id="compassBox">Conseils dynamiques…</div>
          </div>

          <div class="card">
            <h2>Projection annuelle</h2>
            <div class="row">
              <select id="yearSelect"></select>
              <button id="refreshYear">Actualiser</button>
            </div>
            <div id="yearTableWrap"></div>
          </div>

          <div class="card">
            <h2>Export / Import</h2>
            <div class="actions">
              <button id="exportBtn" class="ghost">Exporter JSON</button>
              <input id="importFile" type="file" accept="application/json" />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE EPARGNES -->
    <section id="pageSavings" class="hide">
      <div class="card">
        <h2>Épargnes — objectifs & contributions</h2>
        <div class="row">
          <input id="svName" placeholder="Nom (ex: Meuble salle de bain)" />
          <input id="svTarget" type="number" inputmode="decimal" placeholder="Objectif (DZD)" />
          <button id="svCreate">Créer / Mettre à jour objectif</button>
        </div>
        <div class="row">
          <select id="svSelect"></select>
          <input id="svContrib" type="number" inputmode="decimal" placeholder="Contribution (DZD)" />
          <button id="svAdd">Ajouter contribution</button>
        </div>

        <table class="table">
          <thead><tr><th>Épargne</th><th class="right">Solde</th><th class="right">Objectif</th><th>Progression</th><th></th></tr></thead>
          <tbody id="svBody"></tbody>
        </table>
        <p><span class="pill">Total épargne allouée : <span id="svTotal">0</span> DZD</span></p>
        <p class="muted">Quand le solde atteint l’objectif, le badge devient <strong class="good">VERT</strong>.</p>
      </div>
    </section>
  </div>

  <!-- SW Recovery + App -->
  <script>
  (async function recoverSW(){
    if (!('serviceWorker' in navigator)) return;
    const flag = sessionStorage.getItem('sw_ok_v5');
    if (!flag) {
      try {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (const r of regs) await r.unregister();
        if (window.caches) { for (const k of await caches.keys()) await caches.delete(k); }
      } catch(e) {}
      sessionStorage.setItem('sw_ok_v5','1');
      location.replace(location.href.split('#')[0]);
      return;
    } else {
      navigator.serviceWorker.register('./sw.js?v=5').catch(()=>{});
    }
  })();
  </script>

  <script>
  // ======== STATE & HELPERS (LocalStorage) ========
  const $ = (id)=>document.getElementById(id);
  const fmt = (n)=> new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0)) + " DZD";
  const just= (n)=> new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0));
  const today=()=> new Date().toISOString().slice(0,10);
  const ym   = (d)=> (d||new Date()).toISOString().slice(0,7);
  const ymNow= ()=> ym();

  let baseSalary = Number(localStorage.getItem("salary")||0);
  let cats = JSON.parse(localStorage.getItem("cats")||"[]"); // {id,name,budget}
  let tx   = JSON.parse(localStorage.getItem("tx")||"[]");   // {id,date,catId,amount,note}
  let incomes = JSON.parse(localStorage.getItem("incomes")||"[]"); // {id,date,amount,note}
  let savings = JSON.parse(localStorage.getItem("savings")||"[]"); // {id,name,balance,target}

  function saveAll(){
    localStorage.setItem("salary", baseSalary);
    localStorage.setItem("cats", JSON.stringify(cats));
    localStorage.setItem("tx", JSON.stringify(tx));
    localStorage.setItem("incomes", JSON.stringify(incomes));
    localStorage.setItem("savings", JSON.stringify(savings));
  }

  // ======== CALCULS ========
  function incomeOtherTotal(ymStr){
    return incomes.filter(i => (i.date||"").slice(0,7)===ymStr)
                  .reduce((s,i)=> s + Number(i.amount||0), 0);
  }
  function incomeMonth(ymStr){
    return (Number(baseSalary)||0) + incomeOtherTotal(ymStr);
  }
  function spentMonth(ymStr){
    return tx.filter(t => (t.date||"").slice(0,7)===ymStr)
             .reduce((s,t)=> s + Number(t.amount||0), 0);
  }
  function budgetsTotal(){
    return cats.reduce((s,c)=> s + Number(c.budget||0), 0);
  }
  function savingsTotal(){
    return savings.reduce((s,g)=> s + Number(g.balance||0), 0);
  }
  function theoreticalSave(ymStr){
    return Math.max(0, incomeMonth(ymStr) - spentMonth(ymStr));
  }
  function leftToAllocate(ymStr){
    return Math.max(0, theoreticalSave(ymStr) - savingsTotal());
  }

  // ======== RENDU — BUDGET PAGE ========
  const nowTag = $("nowMonthTag");
  const salaryInput=$("salary"), currentSalary=$("currentSalary");
  const incAmount=$("incAmount"), incDate=$("incDate"), incNote=$("incNote"), incBody=$("incBody"), incTotal=$("incTotal");
  const catName=$("catName"), catBudget=$("catBudget"), catsBody=$("catsBody"), catsTotal=$("catsTotal"), txCat=$("txCat");
  const txAmount=$("txAmount"), txNote=$("txNote"), txDate=$("txDate"), txBody=$("txBody");
  const dashIncome=$("dashIncome"), dashSalary=$("dashSalary"), dashIncOther=$("dashIncOther"), dashCats=$("dashCats"), dashSpent=$("dashSpent"), dashSave=$("dashSave"), dashSavings=$("dashSavings"), dashLeft=$("dashLeft"), barSpent=$("barSpent");
  const exportBtn=$("exportBtn"), importFile=$("importFile");

  txDate.value = today();
  incDate.value = today();
  nowTag.textContent = new Date().toLocaleString("fr-DZ", { month:"long", year:"numeric" });

  function renderSalary(){
    currentSalary.textContent = baseSalary ? fmt(baseSalary) : "—";
    salaryInput.value = baseSalary || "";
  }

  function renderIncomes(){
    const ymC = ymNow();
    const list = incomes.filter(i => (i.date||"").slice(0,7)===ymC).slice().reverse();
    incBody.innerHTML = list.map(i => `
      <tr>
        <td>${i.date||"—"}</td>
        <td>${i.note||""}</td>
        <td class="right">${fmt(i.amount)}</td>
        <td class="right"><button data-del-inc="${i.id}" class="danger" style="padding:6px 8px;border:none;border-radius:8px">Suppr.</button></td>
      </tr>
    `).join("");
    incTotal.textContent = just(incomeOtherTotal(ymC));
  }

  function renderCats(){
    catsBody.innerHTML = cats.map(c => `
      <tr>
        <td>${c.name}</td>
        <td class="right">${fmt(c.budget||0)}</td>
        <td class="right"><button data-del-cat="${c.id}" class="danger" style="padding:6px 8px;border:none;border-radius:8px">Suppr.</button></td>
      </tr>
    `).join("");
    catsTotal.textContent = just(budgetsTotal());
    txCat.innerHTML = cats.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
  }

  function renderTx(){
    const ymC = ymNow();
    txBody.innerHTML = tx.slice().reverse().map(t => {
      const c = cats.find(x => x.id===t.catId);
      return `<tr><td>${t.date||"—"}</td><td>${c?c.name:"—"}</td><td>${t.note||""}</td><td class="right">${fmt(t.amount)}</td></tr>`;
    }).join("");
    const inc = incomeMonth(ymC), spent = spentMonth(ymC), theo = theoreticalSave(ymC), left = leftToAllocate(ymC);
    dashIncome.text
