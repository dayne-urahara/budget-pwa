<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="theme-color" content="#000000"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Budget & √âpargne ‚Äî th√®me noir</title>
<style>
  :root{
    --bg:#000; --card:#111; --ink:#fff; --muted:#b7b7b7; --ring:#222; --accent:#0ea5e9;
    --good:#22c55e; --bad:#ef4444; --warn:#f59e0b; --chip:#0c0c0c; --chip2:#151515;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:20;background:#000; border-bottom:1px solid var(--ring)}
  .topbar{max-width:1280px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
  .logo{font-weight:800;letter-spacing:.2px}
  .tabs{display:flex;gap:8px;margin-left:auto}
  .tab{padding:10px 14px;border:1px solid var(--ring);border-radius:12px;background:var(--chip);color:var(--ink);cursor:pointer}
  .tab.active{background:var(--accent);color:#000;border-color:transparent;font-weight:800}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:10px 0 16px}
  @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  .kpi{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:14px}
  .kpi h4{margin:0 0 6px 0;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.3px}
  .kpi .v{font-size:20px;font-weight:800}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width:1000px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px}
  h2{margin:0 0 10px 0;font-size:18px}
  h3{margin:10px 0 8px 0;font-size:16px}
  input,select,button{width:100%;padding:11px;border-radius:12px;border:1px solid var(--ring);font-size:15px;background:var(--chip2);color:var(--ink)}
  button.btn{border:none;background:var(--accent);color:#000;font-weight:800;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1}
  .muted{color:var(--muted);font-size:14px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{border-bottom:1px dashed #2a2a2a;padding:10px;text-align:left;vertical-align:top}
  .table thead th{color:var(--muted);font-size:13px}
  .right{text-align:right}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0a0a0a;color:#9ee7ff;font-size:12px;border:1px solid #1f2a2e}
  .success{color:var(--good);font-weight:800}
  .danger{background:var(--bad);color:#fff;border:none;padding:7px 10px;border-radius:10px;cursor:pointer}
  .ghost{background:#1a1a1a;color:#fff;border:1px solid #2a2a2a;padding:6px 8px;border-radius:10px;cursor:pointer}
  .bar{height:8px;background:#1a1a1a;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#0ea5e9);width:0%}
  .hint{padding:10px;border-radius:12px;background:#0b0b0b;border:1px dashed #222;font-size:14px;color:#e8e8e8}
  .page{display:none}.page.active{display:block}
  .envHeader{background:#0b0b0b;border:1px solid #222;border-radius:12px;padding:12px;margin:14px 0 8px}
  .warn{color:var(--warn);font-weight:800}
  /* Drag & Drop */
  tbody.dropzone{border:1px dashed #2a2a2a;border-radius:12px}
  tr.dragging{opacity:.5}
  tr.drop-hint{outline:2px solid #0ea5e9}
  /* snackbar erreurs */
  #snack{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;border:1px solid #333;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:50}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="logo">üíé Budget & √âpargne</div>
    <div class="tabs">
      <button id="tabBudget" class="tab active" type="button">Budget</button>
      <button id="tabEpargne" class="tab" type="button">√âpargne & Projets</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi"><h4>Revenus (mois)</h4><div class="v" id="kpiRevenus">‚Äî</div></div>
    <div class="kpi"><h4>Budgets D√©penses (mois)</h4><div class="v" id="kpiBudgets">‚Äî</div></div>
    <div class="kpi"><h4>√âpargne vers√©e (mois)</h4><div class="v" id="kpiSav">‚Äî</div></div>
    <div class="kpi"><h4>Reste indicatif</h4><div class="v" id="kpiLeft">‚Äî</div></div>
  </div>

  <!-- PAGE: BUDGET -->
  <div id="budget" class="page active">
    <div class="grid">
      <div class="card">
        <h2>1) Revenus</h2>
        <div class="row">
          <input id="salaireInput" inputmode="decimal" placeholder="Salaire mensuel (DZD)"/>
          <button class="btn" id="btnSaveSalaire" type="button">Enregistrer</button>
        </div>
        <div class="row">
          <input id="revenuInput" inputmode="decimal" placeholder="Autre revenu ponctuel (DZD)"/>
          <button class="btn" id="btnAddRevenu" type="button">Ajouter revenu</button>
        </div>
        <p id="revenusInfo" class="muted"></p>
      </div>

      <div class="card">
        <h2>2) Enveloppes d‚Äô√âPARGNE</h2>
        <div class="row">
          <input id="savNom" placeholder="Nom (Am√©nagement, Voyage, S√©curit√©, Or‚Ä¶)"/>
          <button class="btn" id="btnAddSavEnv" type="button">Cr√©er enveloppe</button>
        </div>
        <table class="table">
          <thead><tr><th>Enveloppe</th><th class="right">Total vers√©</th><th class="right">Objectif mensuel</th><th></th></tr></thead>
          <tbody id="savBody"></tbody>
        </table>
        <p><span class="pill">Total √©pargne vers√©e : <span id="savTotal">0</span> DZD</span></p>

        <h3>Versement ‚Üí auto-r√©partition (priorit√©s)</h3>
        <div class="row">
          <select id="savSelect"></select>
          <input id="savVersement" inputmode="decimal" placeholder="Montant (DZD)"/>
          <button class="btn" id="btnVerser" type="button">Verser & r√©partir</button>
        </div>
        <p class="muted">Barre : √©pargne vers√©e en % des revenus.</p>
        <div class="bar"><i id="barSav"></i></div>
      </div>

      <div class="card">
        <h2>3) Enveloppes de D√âPENSES (facultatif)</h2>
        <div class="row">
          <input id="depNom" placeholder="Nom (Courses, V√©hicule, Scolaire‚Ä¶)"/>
          <input id="depMontant" inputmode="decimal" placeholder="Budget mensuel (DZD)"/>
          <button class="btn" id="btnAddDepEnv" type="button">Ajouter</button>
        </div>
        <table class="table">
          <thead><tr><th>Cat√©gorie</th><th class="right">Budget</th><th></th></tr></thead>
          <tbody id="depBody"></tbody>
        </table>
        <p><span class="pill">Total d√©penses budg√©t√©es : <span id="depTotal">0</span> DZD</span></p>
      </div>

      <div class="card">
        <h2>4) Export / Import (CHIFFR√â)</h2>
        <div class="row">
          <input id="expPass" type="password" placeholder="Mot de passe export"/>
          <button class="btn" id="btnExport" type="button">Exporter (AES-GCM)</button>
        </div>
        <div class="row">
          <input id="impPass" type="password" placeholder="Mot de passe import"/>
          <input id="impFile" type="file" accept=".json,application/json"/>
          <button class="btn" id="btnImport" type="button">Importer</button>
        </div>
        <p class="muted">PBKDF2(SHA-256, 250k) ‚Üí AES-GCM(256). Garde le mot de passe.</p>
      </div>
    </div>
  </div>

  <!-- PAGE: √âPARGNE & PROJETS -->
  <div id="epargne" class="page">
    <div class="card">
      <h2>Projets (drag & drop + priorit√©s)</h2>
      <div class="row">
        <select id="projEnv"></select>
        <input id="projNom" placeholder="Nom du projet (ex: Meuble salle de bain)"/>
      </div>
      <div class="row">
        <input id="projPrix" inputmode="decimal" placeholder="Objectif (DZD)"/>
        <button class="btn" id="btnAddProjet" type="button">Cr√©er projet</button>
      </div>
      <p class="muted">Le projet en haut est servi en premier lors des versements.</p>
      <div id="projGroups"></div>
    </div>

    <div class="card">
      <h2>Projection & Boussole</h2>
      <div class="row">
        <label class="muted">Moyenne bas√©e sur :</label>
        <select id="avgMonths">
          <option value="3" selected>3 derniers mois</option>
          <option value="6">6 derniers mois</option>
          <option value="12">12 derniers mois</option>
        </select>
        <button class="btn" id="btnRecalc" type="button">Recalculer</button>
      </div>
      <div id="projectionWrap"></div>
      <div class="hint" id="compassBox">Conseils dynamiques‚Ä¶</div>
    </div>
  </div>
</div>

<div id="snack"></div>

<script>
/* ======= Helpers s√ªrs ======= */
const $ = id => document.getElementById(id);
function snack(msg){ const n=$("snack"); n.textContent=msg; n.style.display="block"; setTimeout(()=>n.style.display="none",2500); }
// parseur robuste: accepte "10 000", "10,000", "10.000", "10 000", "10k" (->10000), "1,5" (->1.5)
function toNumber(v){
  if(typeof v==="number") return isFinite(v)?v:0;
  v = (v||"").toString().trim().toLowerCase();
  if(!v) return 0;
  v = v.replace(/\s| /g,"");
  if(/^\d+k$/.test(v)) return parseFloat(v)*1000;
  // si virgule comme d√©cimal (fr), remplace par point si pas d√©j√† un point d√©cimal
  if(v.indexOf(",")>=0 && v.indexOf(".")===-1) v=v.replace(/,/g,".");
  // supprime tout sauf chiffres, point, signe -
  v = v.replace(/[^0-9.-]/g,"");
  const n = parseFloat(v);
  return isFinite(n)? n : 0;
}
// format DZD
const fmt = n => new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0))+" DZD";
const just= n => new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0));
// randomUUID polyfill
if(!(crypto && crypto.randomUUID)){
  crypto.randomUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
    const r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8); return v.toString(16);
  });
}

/* ======= State (isole dans try/catch localStorage) ======= */
let SALAIRE=0, REVENUS_SUPP=0, SAV_ENV=[], SAV_TX=[], PROJ=[], PROJ_TX=[], DEP_ENV=[];
try{
  SALAIRE = toNumber(localStorage.getItem("SALAIRE")||0);
  REVENUS_SUPP = toNumber(localStorage.getItem("REVENUS_SUPP")||0);
  SAV_ENV = JSON.parse(localStorage.getItem("SAV_ENV")||"[]");
  SAV_TX  = JSON.parse(localStorage.getItem("SAV_TX")||"[]");
  PROJ    = JSON.parse(localStorage.getItem("PROJ")||"[]");
  PROJ_TX = JSON.parse(localStorage.getItem("PROJ_TX")||"[]");
  DEP_ENV = JSON.parse(localStorage.getItem("DEP_ENV")||"[]");
}catch(e){
  snack("Stockage indisponible (mode priv√© ?) ‚Äî donn√©es non persist√©es.");
  SALAIRE=0; REVENUS_SUPP=0; SAV_ENV=[]; SAV_TX=[]; PROJ=[]; PROJ_TX=[]; DEP_ENV=[];
}
function persist(){
  try{
    localStorage.setItem("SALAIRE",SALAIRE);
    localStorage.setItem("REVENUS_SUPP",REVENUS_SUPP);
    localStorage.setItem("SAV_ENV",JSON.stringify(SAV_ENV));
    localStorage.setItem("SAV_TX",JSON.stringify(SAV_TX));
    localStorage.setItem("PROJ",JSON.stringify(PROJ));
    localStorage.setItem("PROJ_TX",JSON.stringify(PROJ_TX));
    localStorage.setItem("DEP_ENV",JSON.stringify(DEP_ENV));
  }catch(e){ /* ignore quota errors silently */ }
}

/* ======= Navigation (blind√©e) ======= */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  const page = $(id);
  const tab  = (id==="budget")? $("tabBudget") : $("tabEpargne");
  if(page) page.classList.add("active");
  if(tab)  tab.classList.add("active");
}
$("tabBudget").addEventListener("click", ()=>showPage("budget"));
$("tabEpargne").addEventListener("click", ()=>showPage("epargne"));

/* ======= Calculs ======= */
const monthKeysBack = n => {
  const arr=[]; const d=new Date();
  for(let i=0;i<n;i++){ const dd=new Date(d.getFullYear(), d.getMonth()-i, 1); arr.push(dd.toISOString().slice(0,7)); }
  return arr;
};
const sumDepBudgets = () => DEP_ENV.reduce((s,c)=>s+toNumber(c.budget),0);
const totalRevenus  = () => toNumber(SALAIRE) + toNumber(REVENUS_SUPP);
const totalSavAlloue= () => SAV_ENV.reduce((s,e)=> s + toNumber(e.totalIn||0), 0);

/* ======= Revenus ======= */
function saveSalaire(){
  const v = toNumber($("salaireInput").value);
  if(!v){ snack("Salaire invalide."); return; }
  SALAIRE=v; $("salaireInput").value="";
  persist(); renderAll();
}
function addRevenu(){
  const v = toNumber($("revenuInput").value);
  if(!v){ snack("Montant de revenu invalide."); return; }
  REVENUS_SUPP += v; $("revenuInput").value="";
  persist(); renderAll();
}

/* ======= √âpargne ‚Äì enveloppes ======= */
function addSavEnv(){
  const name = ($("savNom").value||"").trim();
  if(!name){ snack("Nom d‚Äôenveloppe requis."); return; }
  SAV_ENV.push({id:crypto.randomUUID(),name,totalIn:0,targetM:0});
  $("savNom").value="";
  persist(); renderAll();
}
function delSavEnv(id){
  SAV_TX = SAV_TX.filter(t=>t.envId!==id);
  const projIds = PROJ.filter(p=>p.envId===id).map(p=>p.id);
  PROJ_TX = PROJ_TX.filter(x=> !projIds.includes(x.projectId));
  PROJ = PROJ.filter(p=>p.envId!==id);
  SAV_ENV = SAV_ENV.filter(e=>e.id!==id);
  persist(); renderAll();
}
function setEnvTarget(envId){
  const el = document.getElementById("targetM-"+envId);
  const v = toNumber(el?.value);
  const env = SAV_ENV.find(e=>e.id===envId);
  if(!env) return;
  env.targetM = v>0 ? v : 0;
  persist(); renderAll();
}

/* ‚Äî Versement + auto-r√©partition (priorit√©s) ‚Äî */
function ensurePriorities(envId){
  const ps = PROJ.filter(p=>p.envId===envId);
  ps.sort((a,b)=> (a.priority??Number.MAX_SAFE_INTEGER) - (b.priority??Number.MAX_SAFE_INTEGER));
  ps.forEach((p,i)=> p.priority=i);
}
function verserEpargne(){
  if(!SAV_ENV.length){ snack("Cr√©e d‚Äôabord une enveloppe d‚Äô√©pargne."); return; }
  const envId = $("savSelect").value;
  const amount = toNumber($("savVersement").value);
  if(!amount){ snack("Montant invalide."); return; }

  const today = new Date().toISOString().slice(0,10);
  SAV_TX.push({id:crypto.randomUUID(),date:today,envId,amount});
  const env = SAV_ENV.find(e=>e.id===envId);
  env.totalIn = toNumber(env.totalIn||0) + amount;

  ensurePriorities(envId);
  let remain = amount;
  const list = PROJ
    .filter(p=>p.envId===envId && !p.done)
    .sort((a,b)=> (a.priority??0) - (b.priority??0));

  for(const p of list){
    if(remain<=0) break;
    const need = Math.max(0, toNumber(p.target) - toNumber(p.saved));
    if(need<=0){ p.done=true; continue; }
    const take = Math.min(need, remain);
    p.saved = toNumber(p.saved) + take;
    PROJ_TX.push({id:crypto.randomUUID(),date:today,projectId:p.id,amount:take,envId});
    if(p.saved >= p.target){ p.done = true; }
    remain -= take;
  }
  $("savVersement").value="";
  persist(); renderAll();
}

/* ======= Projets ======= */
function getNextPriority(envId){
  const ps = PROJ.filter(p=>p.envId===envId);
  if(!ps.length) return 0;
  return Math.max(...ps.map(p=> (p.priority??0))) + 1;
}
function addProjet(){
  if(!SAV_ENV.length){ snack("Cr√©e d‚Äôabord une enveloppe d‚Äô√©pargne."); return; }
  const envId = $("projEnv").value;
  const name = ($("projNom").value||"").trim();
  const target = toNumber($("projPrix").value);
  if(!name || !target){ snack("Nom et objectif requis."); return; }
  const prio = getNextPriority(envId);
  PROJ.push({id:crypto.randomUUID(),name,envId,target,saved:0,done:false,priority:prio});
  $("projNom").value=""; $("projPrix").value="";
  persist(); renderAll();
}
function delProjet(id){
  const envId = PROJ.find(p=>p.id===id)?.envId;
  PROJ = PROJ.filter(p=>p.id!==id);
  PROJ_TX = PROJ_TX.filter(t=>t.projectId!==id);
  if(envId) ensurePriorities(envId);
  persist(); renderAll();
}
function moveProject(id, dir){
  const p = PROJ.find(x=>x.id===id); if(!p) return;
  ensurePriorities(p.envId);
  const sib = PROJ.filter(x=>x.envId===p.envId).sort((a,b)=>a.priority-b.priority);
  const idx = sib.findIndex(x=>x.id===id);
  const j = idx + dir; if (j<0 || j>=sib.length) return;
  const a=sib[idx], b=sib[j]; const tmp=a.priority; a.priority=b.priority; b.priority=tmp;
  persist(); renderAll();
}

/* ---- Drag & Drop ---- */
let dragState = { id:null, envId:null };
function attachDnD(){
  document.querySelectorAll('tbody.dropzone').forEach(tbody=>{
    tbody.addEventListener('dragover', (e)=>{ e.preventDefault(); const tr = e.target.closest('tr[data-id]'); if(tr) tr.classList.add('drop-hint'); });
    tbody.addEventListener('dragleave', (e)=>{ const tr = e.target.closest('tr[data-id]'); if(tr) tr.classList.remove('drop-hint'); });
    tbody.addEventListener('drop', (e)=>{
      e.preventDefault();
      const zone = e.currentTarget;
      if (!dragState.id || dragState.envId !== zone.dataset.envId) return;
      const rows = Array.from(zone.querySelectorAll('tr[data-id]'));
      rows.forEach(r=>r.classList.remove('drop-hint'));
      const targetRow = e.target.closest('tr[data-id]');
      const draggedId = dragState.id;
      const orderIds = rows.map(r=>r.dataset.id).filter(x=>x!==draggedId);
      if (targetRow) {
        const idx = rows.findIndex(r=>r===targetRow);
        orderIds.splice(idx, 0, draggedId);
      } else {
        orderIds.push(draggedId);
      }
      orderIds.forEach((pid, i)=>{ const p = PROJ.find(x=>x.id===pid); if (p) p.priority = i; });
      dragState.id=null; dragState.envId=null;
      persist(); renderAll();
    });
  });
  document.querySelectorAll('tr[data-id]').forEach(tr=>{
    tr.setAttribute('draggable','true');
    tr.addEventListener('dragstart', ()=>{
      tr.classList.add('dragging');
      dragState.id = tr.dataset.id;
      dragState.envId = tr.dataset.envId;
    });
    tr.addEventListener('dragend', ()=> tr.classList.remove('dragging'));
  });
}

/* ======= Projection & Boussole ======= */
function avgMonthlyForEnv(envId, monthsWindow){
  const keys = monthKeysBack(monthsWindow);
  const sums = {}; keys.forEach(k=>sums[k]=0);
  for(const t of SAV_TX){
    if(t.envId!==envId) continue;
    const k = (t.date||"").slice(0,7);
    if (sums[k]!==undefined) sums[k] += toNumber(t.amount);
  }
  const total = keys.reduce((s,k)=> s + (sums[k]||0), 0);
  return total / keys.length;
}
const addMonths = (d,n)=> new Date(d.getFullYear(), d.getMonth()+n, 1);
function computeProjectionData(monthsWindow){
  const rowsByEnv={};
  for(const env of SAV_ENV){
    const avg = avgMonthlyForEnv(env.id, monthsWindow);
    const list = PROJ.filter(p=>p.envId===env.id).sort((a,b)=>(a.priority??0)-(b.priority??0));
    let cursor=0;
    rowsByEnv[env.id] = { name:env.name, avg, targetM:env.targetM||0, items:[] };
    for(const p of list){
      const remaining = Math.max(0, toNumber(p.target) - toNumber(p.saved));
      if (remaining===0){ rowsByEnv[env.id].items.push({project:p.name, remaining:0, months:0, eta:new Date(), done:true}); continue; }
      if (avg<=0){ rowsByEnv[env.id].items.push({project:p.name, remaining, months:Infinity, eta:null, done:false}); continue; }
      const mNeeded = Math.ceil(remaining / avg);
      cursor += mNeeded;
      rowsByEnv[env.id].items.push({project:p.name, remaining, months:mNeeded, eta:addMonths(new Date(), cursor), done:false});
    }
  }
  return rowsByEnv;
}
function renderProjection(){
  const win = Number(($("avgMonths").value||3));
  const byEnv = computeProjectionData(win);

  let html="";
  const ids = Object.keys(byEnv).sort((a,b)=> byEnv[a].name.localeCompare(byEnv[b].name));
  ids.forEach(id=>{
    const g = byEnv[id];
    html += `
      <div class="envHeader">
        <div class="row" style="align-items:center">
          <div style="flex:2"><strong>Enveloppe :</strong> ${g.name}</div>
          <div><span class="pill">Moyenne (${win}m) : ${fmt(g.avg||0)}</span></div>
          <div class="row" style="gap:6px;flex:1">
            <input id="targetM-${id}" placeholder="Objectif mensuel (DZD)" value="${SAV_ENV.find(e=>e.id===id)?.targetM||''}">
            <button class="btn" type="button" onclick="setEnvTarget('${id}')">Fixer objectif</button>
          </div>
        </div>
        <div class="muted">√âcart (moyenne ‚àí objectif) : <strong>${fmt((g.avg||0)-(SAV_ENV.find(e=>e.id===id)?.targetM||0))}</strong></div>
      </div>
      <table class="table">
        <thead><tr><th>Projet</th><th class="right">Restant</th><th class="right">Mois estim√©s</th><th>Date estim√©e</th><th>Statut</th></tr></thead>
        <tbody>
          ${
            g.items.map(it=>{
              const eta = it.eta ? it.eta.toLocaleString("fr-DZ",{year:"numeric", month:"long"}) : "‚Äî";
              let statut = "";
              if (it.done) statut = `<span class="success">Atteint ‚úÖ</span>`;
              else if (!isFinite(it.months)) statut = `<span class="warn">Aucun versement r√©cent</span>`;
              else statut = it.months<=12 ? `<span class="success">‚â§ 12 mois</span>` : `<span class="muted">> 12 mois</span>`;
              return `<tr>
                <td>${it.project}</td>
                <td class="right">${fmt(it.remaining)}</td>
                <td class="right">${isFinite(it.months)? it.months : "‚àû"}</td>
                <td>${eta}</td>
                <td>${statut}</td>
              </tr>`;
            }).join("")
          }
        </tbody>
      </table>
    `;
  });
  $("projectionWrap").innerHTML = html;

  // Boussole agressive
  const tips=[];
  const totalTargets = SAV_ENV.reduce((s,e)=> s + toNumber(e.targetM||0), 0);
  const cash = totalRevenus() - sumDepBudgets();
  if (totalTargets > cash){
    const gap = totalTargets - cash;
    tips.push(`<p class="warn">Objectifs d‚Äô√©pargne > cash disponible de <strong>${fmt(gap)}</strong>. 
    ‚Üí R√©duis des budgets ou baisse provisoirement les objectifs. Reco: -${fmt(Math.ceil(gap/Math.max(1,SAV_ENV.length)))}/mois sur chaque enveloppe.</p>`);
  }
  const win = Number(($("avgMonths").value||3));
  const starving = SAV_ENV.filter(e=> (avgMonthlyForEnv(e.id, win)||0)===0 && PROJ.some(p=>p.envId===e.id && !p.done));
  if (starving.length){
    tips.push(`<p class="warn">Pas de versement r√©cent sur : ${starving.map(e=>`<strong>${e.name}</strong>`).join(", ")}. Fixe un minimum (ex: 5‚Äì10% des revenus).</p>`);
  }
  SAV_ENV.forEach(e=>{
    const avg = avgMonthlyForEnv(e.id, win)||0;
    const targ = toNumber(e.targetM||0);
    if (targ>0 && avg < targ){
      tips.push(`<p>Augmente <strong>${e.name}</strong> de <strong>${fmt(targ-avg)}</strong>/mois pour tenir l‚Äôobjectif.</p>`);
    }
  });
  SAV_ENV.forEach(e=>{
    const list = PROJ.filter(p=>p.envId===e.id);
    const sumRemaining = list.reduce((s,p)=> s + Math.max(0, toNumber(p.target)-toNumber(p.saved)), 0);
    if (sumRemaining>0){
      const needPerMonth = Math.ceil(sumRemaining/12);
      const avg = avgMonthlyForEnv(e.id, win)||0;
      if (avg < needPerMonth){
        tips.push(`<p>${e.name}: pour boucler tous les projets ‚â§ 12 mois, vise <strong>${fmt(needPerMonth)}</strong>/mois (actuel: ${fmt(avg)}).</p>`);
      }
    }
  });
  if (!tips.length){
    tips.push(`<p class="success">Cap OK : objectifs soutenables avec tes versements actuels.</p>`);
  }
  $("compassBox").innerHTML = tips.join("");
}

/* ======= Rendering ======= */
function renderBudget(){
  const revenus = totalRevenus();
  const budgets = sumDepBudgets();
  const sav = totalSavAlloue();
  const left = Math.max(0, revenus - budgets - sav);

  $("kpiRevenus").textContent = fmt(revenus);
  $("kpiBudgets").textContent = fmt(budgets);
  $("kpiSav").textContent = fmt(sav);
  $("kpiLeft").textContent = fmt(left);

  $("revenusInfo").innerHTML = `üí∞ Salaire : ${fmt(SALAIRE)} ‚Ä¢ ‚ûï Revenus sup. : ${fmt(REVENUS_SUPP)} ‚Ä¢ üìä Total : ${fmt(revenus)}`;

  $("savBody").innerHTML = SAV_ENV.map(e=>{
    const t = e.targetM||0;
    return `
      <tr>
        <td>${e.name}</td>
        <td class="right">${fmt(e.totalIn||0)}</td>
        <td class="right">${t?fmt(t):"<span class='muted'>‚Äî</span>"}</td>
        <td class="right"><button class="danger" onclick="delSavEnv('${e.id}')">Suppr.</button></td>
      </tr>
    `;
  }).join("");
  $("savTotal").textContent = just(totalSavAlloue());
  $("savSelect").innerHTML = SAV_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");

  $("depBody").innerHTML = DEP_ENV.map(e=>`
    <tr>
      <td>${e.name}</td>
      <td class="right">${fmt(e.budget||0)}</td>
      <td class="right"><button class="danger" onclick="delDepenseEnv('${e.id}')">Suppr.</button></td>
    </tr>
  `).join("");
  $("depTotal").textContent = just(sumDepBudgets());

  const ratio = revenus ? Math.min(100, Math.round((sav/revenus)*100)) : 0;
  $("barSav").style.width = ratio + "%";

  $("projEnv").innerHTML = SAV_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
}
function renderProjectsGrouped(){
  const groups = {};
  for(const e of SAV_ENV){ groups[e.id] = { name:e.name, id:e.id, items:[] }; }
  for(const p of PROJ){ if(groups[p.envId]) groups[p.envId].items.push(p); }

  let html = "";
  const envIds = Object.keys(groups).sort((a,b)=> groups[a].name.localeCompare(groups[b].name));
  envIds.forEach(envId=>{
    ensurePriorities(envId);
    const g = groups[envId];
    const items = g.items.slice().sort((a,b)=>(a.priority??0)-(b.priority??0));
    html += `
      <div class="envHeader"><strong>Enveloppe :</strong> ${g.name}</div>
      <table class="table">
        <thead><tr><th>Projet</th><th class="right">Objectif</th><th class="right">√âpargn√©</th><th>Progression</th><th>Priorit√©</th><th></th></tr></thead>
        <tbody class="dropzone" data-env-id="${g.id}">
          ${items.map(p=>{
            const pct = p.target ? Math.min(100, Math.round((toNumber(p.saved)/toNumber(p.target))*100)) : 0;
            const status = (p.done || toNumber(p.saved)>=toNumber(p.target)) ? `<span class="success">Atteint ‚úÖ</span>` : `${pct}%`;
            return `
              <tr data-id="${p.id}" data-env-id="${p.envId}">
                <td>${p.name}</td>
                <td class="right">${fmt(p.target)}</td>
                <td class="right">${fmt(p.saved||0)}</td>
                <td>
                  <div class="bar"><i style="width:${pct}%"></i></div>
                  <div class="muted">${status}</div>
                </td>
                <td>
                  <div class="row" style="gap:6px">
                    <button class="ghost" onclick="moveProject('${p.id}', -1)">‚¨ÜÔ∏è</button>
                    <button class="ghost" onclick="moveProject('${p.id}', 1)">‚¨áÔ∏è</button>
                  </div>
                  <div class="muted">rang: ${p.priority??0}</div>
                </td>
                <td class="right"><button class="danger" onclick="delProjet('${p.id}')">Suppr.</button></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;
  });

  $("projGroups").innerHTML = html;
  attachDnD();
}
function renderEpargne(){
  renderProjectsGrouped();
  renderProjection();
}
function renderAll(){
  renderBudget();
  renderEpargne();
}

/* ======= Export / Import CHIFFR√â ======= */
function b64enc(buf){ const bytes = buf instanceof Uint8Array ? buf : new Uint8Array(buf); let bin=""; for(let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]); return btoa(bin); }
function b64dec(b64){ const bin = atob(b64); const len = bin.length; const bytes = new Uint8Array(len); for(let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i); return bytes; }
async function deriveKey(pass, salt, iterations=250000){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
  return await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations, hash:'SHA-256'},
    baseKey,{name:'AES-GCM', length:256},false,['encrypt','decrypt']
  );
}
async function exportEncrypted(){
  try{
    const pass = ($("expPass").value||"").trim();
    if(!pass){ snack("Mot de passe requis pour l‚Äôexport."); return; }
    const data = { SALAIRE, REVENUS_SUPP, SAV_ENV, SAV_TX, PROJ, PROJ_TX, DEP_ENV };
    const enc = new TextEncoder().encode(JSON.stringify(data));
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await deriveKey(pass, salt, 250000);
    const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc);
    const payload = { v:1, alg:'AES-GCM', kdf:'PBKDF2', iter:250000, salt:b64enc(salt), iv:b64enc(iv), ct:b64enc(ct) };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download=`budget-secure-${new Date().toISOString().slice(0,10)}.json`;
    a.click(); URL.revokeObjectURL(url);
    snack("Export chiffr√© OK.");
  }catch(e){ snack("√âchec export: "+e.message); }
}
async function importEncrypted(){
  try{
    const pass = ($("impPass").value||"").trim();
    const file = $("impFile").files?.[0];
    if(!pass){ snack("Mot de passe de d√©chiffrement requis."); return; }
    if(!file){ snack("Choisis le fichier export√©."); return; }
    const text = await file.text();
    const payload = JSON.parse(text);
    const salt = b64dec(payload.salt);
    const iv   = b64dec(payload.iv);
    const ct   = b64dec(payload.ct);
    const key  = await deriveKey(pass, salt, payload.iter||250000);
    const pt   = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
    const json = JSON.parse(new TextDecoder().decode(pt));
    SALAIRE = toNumber(json.SALAIRE||0);
    REVENUS_SUPP = toNumber(json.REVENUS_SUPP||0);
    SAV_ENV = Array.isArray(json.SAV_ENV)? json.SAV_ENV : [];
    SAV_TX  = Array.isArray(json.SAV_TX)? json.SAV_TX : [];
    PROJ    = Array.isArray(json.PROJ)? json.PROJ : [];
    PROJ_TX = Array.isArray(json.PROJ_TX)? json.PROJ_TX : [];
    DEP_ENV = Array.isArray(json.DEP_ENV)? json.DEP_ENV : [];
    persist(); renderAll(); snack("Import OK.");
  }catch(e){ snack("√âchec import (mot de passe ? fichier ?) : "+e.message); }
}

/* ======= Events ======= */
$("btnSaveSalaire").addEventListener("click", saveSalaire);
$("btnAddRevenu").addEventListener("click", addRevenu);
$("btnAddSavEnv").addEventListener("click", addSavEnv);
$("btnVerser").addEventListener("click", verserEpargne);
$("btnAddDepEnv").addEventListener("click", ()=>{
  const name = ($("depNom").value||"").trim();
  const bud  = toNumber($("depMontant").value);
  if(!name || !bud){ snack("Nom et budget requis."); return; }
  DEP_ENV.push({id:crypto.randomUUID(),name,budget:bud});
  $("depNom").value=""; $("depMontant").value="";
  persist(); renderAll();
});
$("btnAddProjet").addEventListener("click", addProjet);
$("btnRecalc").addEventListener("click", renderProjection);
$("btnExport").addEventListener("click", exportEncrypted);
$("btnImport").addEventListener("click", importEncrypted);

/* ======= Boot ======= */
(function init(){
  try{
    renderAll();
  }catch(e){
    console.error(e);
    snack("Erreur d‚Äôinitialisation: "+e.message);
  }
})();
</script>
</body>
</html>
