<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Budget & √âpargne (auto-allocation par enveloppe)</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#667085;--ring:#e5e7eb;--accent:#2563eb;--good:#16a34a;--bad:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{background:#111827;color:#fff;padding:16px}
  header h1{margin:0;font-size:20px}
  nav{display:flex;background:#1f2937}
  nav button{flex:1;padding:12px 10px;border:none;background:#1f2937;color:#fff;cursor:pointer;font-size:16px}
  nav button.active{background:#0b1220;font-weight:600}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .page{display:none}
  .page.active{display:block}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:1000px){.grid{grid-template-columns:1.2fr .8fr}}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  h2{margin:0 0 10px 0;font-size:18px}
  input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);font-size:16px;background:#fff}
  button.btn{border:none;background:var(--accent);color:#fff;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1}
  .muted{color:var(--muted);font-size:14px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{border-bottom:1px dashed #e5e7eb;padding:8px;text-align:left;vertical-align:top}
  .right{text-align:right}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px}
  .success{color:var(--good);font-weight:600}
  .danger{background:var(--bad);color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer}
  .bar{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;background:#22c55e;width:0%}
  .tag{padding:2px 8px;border-radius:999px;font-size:12px;background:#f1f5f9}
</style>
</head>
<body>
<header><h1>Gestionnaire de Budget & √âpargne</h1></header>
<nav>
  <button id="btnBudget" class="active" onclick="showPage('budget')">üí∞ Budget</button>
  <button id="btnEpargne" onclick="showPage('epargne')">üìä √âpargne & Projets</button>
</nav>

<div class="wrap">
  <!-- PAGE BUDGET -->
  <div id="budget" class="page active">
    <div class="grid">
      <div class="grid-col">
        <div class="card">
          <h2>1) Salaire & Autres revenus</h2>
          <div class="row">
            <input id="salaireInput" type="number" inputmode="decimal" placeholder="Salaire mensuel (DZD)"/>
            <button class="btn" onclick="saveSalaire()">Enregistrer</button>
          </div>
          <div class="row">
            <input id="revenuInput" type="number" inputmode="decimal" placeholder="Autre revenu ponctuel (DZD)"/>
            <button class="btn" onclick="addRevenu()">Ajouter revenu</button>
          </div>
          <p id="salaireAffiche" class="muted"></p>
        </div>

        <div class="card">
          <h2>2) Enveloppes de D√âPENSES (budgets)</h2>
          <div class="row">
            <input id="depNom" placeholder="Nom (Courses, V√©hicule, Scolaire‚Ä¶)"/>
            <input id="depMontant" type="number" inputmode="decimal" placeholder="Budget mensuel (DZD)"/>
            <button class="btn" onclick="addDepenseEnv()">Ajouter</button>
          </div>
          <table class="table">
            <thead><tr><th>Enveloppe</th><th class="right">Budget</th><th></th></tr></thead>
            <tbody id="depBody"></tbody>
          </table>
          <p><span class="pill">Total d√©penses budg√©t√©es : <span id="depTotal">0</span> DZD</span></p>
        </div>

        <div class="card">
          <h2>3) D√©penses effectives (mois en cours)</h2>
          <div class="row">
            <select id="txCat"></select>
            <input id="txAmount" type="number" inputmode="decimal" placeholder="Montant (DZD)"/>
          </div>
          <div class="row">
            <input id="txNote" placeholder="Note (facultatif)"/>
            <input id="txDate" type="date"/>
          </div>
          <div class="row">
            <button class="btn" onclick="addDepenseTx()">Ajouter d√©pense</button>
            <button class="danger" onclick="clearDepenseTx()">Vider l'historique</button>
          </div>
          <table class="table">
            <thead><tr><th>Date</th><th>Cat√©gorie</th><th>Note</th><th class="right">Montant</th></tr></thead>
            <tbody id="txBody"></tbody>
          </table>
        </div>
      </div>

      <div class="grid-col">
        <div class="card">
          <h2>Dashboard</h2>
          <p class="muted"><span class="tag" id="nowMonth"></span></p>
          <p>Salaire + revenus : <strong id="dashRevenus">‚Äî</strong></p>
          <p>Total d√©penses budg√©t√©es : <strong id="dashDepBudg">‚Äî</strong></p>
          <p>Total d√©pens√© (mois) : <strong id="dashDepense">‚Äî</strong></p>
          <p>√âpargne th√©orique (revenus ‚àí d√©penses) : <strong id="dashTheoSave">‚Äî</strong></p>
          <p>√âpargne allou√©e (toutes enveloppes √©pargne) : <strong id="dashSavAlloue">‚Äî</strong></p>
          <p>Reste √† allouer : <strong id="dashLeft">‚Äî</strong></p>
          <div class="bar"><i id="barSpent"></i></div>
          <p class="muted">% d√©pens√© vs revenus (mois courant).</p>
        </div>

        <div class="card">
          <h2>4) Enveloppes d‚Äô√âPARGNE</h2>
          <div class="row">
            <input id="savNom" placeholder="Nom (Am√©nagement, Voyage, S√©curit√©, Or‚Ä¶)"/>
            <button class="btn" onclick="addSavEnv()">Cr√©er enveloppe d‚Äô√©pargne</button>
          </div>
          <table class="table">
            <thead><tr><th>Enveloppe</th><th class="right">Total vers√©</th><th></th></tr></thead>
            <tbody id="savBody"></tbody>
          </table>
          <p><span class="pill">Total √©pargne vers√©e : <span id="savTotal">0</span> DZD</span></p>

          <h3 style="margin-top:16px">Versement dans une enveloppe d‚Äô√©pargne</h3>
          <div class="row">
            <select id="savSelect"></select>
            <input id="savVersement" type="number" inputmode="decimal" placeholder="Montant √† verser (DZD)"/>
            <button class="btn" onclick="verserEpargne()">Verser & r√©partir</button>
          </div>
          <p class="muted">Le versement est automatiquement r√©parti entre les projets <em>li√©s √† cette enveloppe</em> jusqu‚Äô√† atteindre leurs objectifs.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- PAGE √âPARGNE & PROJETS -->
  <div id="epargne" class="page">
    <div class="card">
      <h2>Projets d‚Äô√©pargne (li√©s √† une enveloppe)</h2>
      <div class="row">
        <select id="projEnv"></select>
        <input id="projNom" placeholder="Nom du projet (ex: Meuble salle de bain, Voyage Paris‚Ä¶)"/>
      </div>
      <div class="row">
        <input id="projPrix" type="number" inputmode="decimal" placeholder="Prix / objectif (DZD)"/>
        <button class="btn" onclick="addProjet()">Cr√©er projet</button>
      </div>
      <p class="muted">‚öôÔ∏è Le projet sera aliment√© automatiquement par les versements de son enveloppe (FIFO : les plus anciens projets sont compl√©t√©s d‚Äôabord).</p>

      <table class="table">
        <thead><tr><th>Projet</th><th>Enveloppe</th><th class="right">Objectif</th><th class="right">√âpargn√©</th><th>Progression</th><th></th></tr></thead>
        <tbody id="projBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ========= State & Storage ========= */
const $ = id => document.getElementById(id);
const fmt = n => new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0))+" DZD";
const just = n => new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0));
const today = () => new Date().toISOString().slice(0,10);
const ymNow = () => new Date().toISOString().slice(0,7);

let SALAIRE = Number(localStorage.getItem("SALAIRE")||0);
let REVENUS_SUPP = Number(localStorage.getItem("REVENUS_SUPP")||0);

// Enveloppes de d√©penses (budgets mensuels ‚Äúcibles‚Äù)
let DEP_ENV = JSON.parse(localStorage.getItem("DEP_ENV")||"[]");      // {id,name,budget}
let DEP_TX  = JSON.parse(localStorage.getItem("DEP_TX")||"[]");       // {id,date,catId,amount,note}

// Enveloppes d‚Äô√©pargne
let SAV_ENV = JSON.parse(localStorage.getItem("SAV_ENV")||"[]");      // {id,name,totalIn}
let SAV_TX  = JSON.parse(localStorage.getItem("SAV_TX")||"[]");       // {id,date,envId,amount}

// Projets li√©s √† une enveloppe
let PROJ    = JSON.parse(localStorage.getItem("PROJ")||"[]");         // {id,name,envId,target,saved,done}
let PROJ_TX = JSON.parse(localStorage.getItem("PROJ_TX")||"[]");      // {id,date,projectId,amount,envId}

function persist(){
  localStorage.setItem("SALAIRE",SALAIRE);
  localStorage.setItem("REVENUS_SUPP",REVENUS_SUPP);
  localStorage.setItem("DEP_ENV",JSON.stringify(DEP_ENV));
  localStorage.setItem("DEP_TX",JSON.stringify(DEP_TX));
  localStorage.setItem("SAV_ENV",JSON.stringify(SAV_ENV));
  localStorage.setItem("SAV_TX",JSON.stringify(SAV_TX));
  localStorage.setItem("PROJ",JSON.stringify(PROJ));
  localStorage.setItem("PROJ_TX",JSON.stringify(PROJ_TX));
}

/* ========= Navigation ========= */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  $(id).classList.add("active");
  (id==="budget"?$("btnBudget"):$("btnEpargne")).classList.add("active");
}

/* ========= Helpers calcul ========= */
function totalDepenseMonth(ym){
  return DEP_TX.filter(t=> (t.date||"").slice(0,7)===ym).reduce((s,t)=>s+Number(t.amount||0),0);
}
function spentByCatMonth(ym){
  const m={};
  for(const t of DEP_TX){
    if((t.date||"").slice(0,7)!==ym) continue;
    m[t.catId]=(m[t.catId]||0)+Number(t.amount||0);
  }
  return m;
}
function sumDepBudgets(){ return DEP_ENV.reduce((s,c)=>s+Number(c.budget||0),0); }
function totalRevenus(){ return (Number(SALAIRE)||0)+(Number(REVENUS_SUPP)||0); }
function totalSavAlloue(){ return SAV_ENV.reduce((s,e)=> s + Number(e.totalIn||0), 0); }
function theoSave(ym){ return Math.max(0, totalRevenus() - totalDepenseMonth(ym)); }
function leftToAllocate(ym){ return Math.max(0, theoSave(ym) - totalSavAlloue()); }

/* ========= UI: Budget ========= */
function saveSalaire(){
  const v = Number(($("salaireInput").value||0));
  if(!v) return alert("Entre un salaire valide.");
  SALAIRE=v; persist(); renderBudgetAll();
}
function addRevenu(){
  const v = Number(($("revenuInput").value||0));
  if(!v) return alert("Montant invalide.");
  REVENUS_SUPP += v; $("revenuInput").value="";
  persist(); renderBudgetAll();
}

function addDepenseEnv(){
  const name = ($("depNom").value||"").trim();
  const bud  = Number(($("depMontant").value||0));
  if(!name || !bud) return alert("Nom et budget requis.");
  DEP_ENV.push({id:crypto.randomUUID(),name,budget:bud});
  $("depNom").value=""; $("depMontant").value="";
  persist(); renderBudgetAll();
}

function delDepenseEnv(id){
  // supprime d√©penses li√©es
  DEP_TX = DEP_TX.filter(t=>t.catId!==id);
  DEP_ENV = DEP_ENV.filter(e=>e.id!==id);
  persist(); renderBudgetAll();
}

function addDepenseTx(){
  if(!DEP_ENV.length) return alert("Cr√©e d'abord une enveloppe de d√©penses.");
  const catId = $("txCat").value;
  const amount = Number(($("txAmount").value||0));
  if(!amount || amount<=0) return alert("Montant invalide.");
  DEP_TX.push({id:crypto.randomUUID(),date:$("txDate").value||today(),catId,amount,note:($("txNote").value||"").trim()});
  $("txAmount").value=""; $("txNote").value="";
  persist(); renderBudgetAll();
}
function clearDepenseTx(){
  if(!confirm("Supprimer tout l'historique des d√©penses ?")) return;
  DEP_TX=[]; persist(); renderBudgetAll();
}

/* ========= UI: √âpargne ========= */
function addSavEnv(){
  const name = ($("savNom").value||"").trim();
  if(!name) return alert("Nom requis.");
  SAV_ENV.push({id:crypto.randomUUID(),name,totalIn:0});
  $("savNom").value="";
  persist(); renderBudgetAll(); renderEpargneAll();
}

function delSavEnv(id){
  // supprime versements (on garde l‚Äôhistorique projet mais ce n‚Äôest pas bloquant)
  SAV_TX = SAV_TX.filter(t=>t.envId!==id);
  // supprime projets li√©s + tx projets li√©s
  const projIds = PROJ.filter(p=>p.envId===id).map(p=>p.id);
  PROJ_TX = PROJ_TX.filter(x=> !projIds.includes(x.projectId));
  PROJ = PROJ.filter(p=>p.envId!==id);
  // supprime enveloppe
  SAV_ENV = SAV_ENV.filter(e=>e.id!==id);
  persist(); renderBudgetAll(); renderEpargneAll();
}

function verserEpargne(){
  if(!SAV_ENV.length) return alert("Cr√©e d'abord une enveloppe d‚Äô√©pargne.");
  const envId = $("savSelect").value;
  const amount = Number(($("savVersement").value||0));
  if(!amount || amount<=0) return alert("Montant invalide.");
  // Enregistre le versement dans enveloppe
  SAV_TX.push({id:crypto.randomUUID(),date:today(),envId,amount});
  const env = SAV_ENV.find(e=>e.id===envId);
  env.totalIn = Number(env.totalIn||0) + amount;

  // R√©partition automatique aux projets li√©s (FIFO : plus anciens non-termin√©s d‚Äôabord)
  autoAllocateToProjects(envId, amount);

  $("savVersement").value="";
  persist(); renderBudgetAll(); renderEpargneAll();
}

function autoAllocateToProjects(envId, amount){
  // prend les projets non termin√©s de l‚Äôenveloppe
  const list = PROJ.filter(p=>p.envId===envId && !p.done);
  // ordre FIFO (cr√©ation) = ordre d‚Äôapparition
  let remain = amount;
  for(const p of list){
    if(remain<=0) break;
    const need = Math.max(0, Number(p.target||0) - Number(p.saved||0));
    if(need<=0){ p.done = true; continue; }
    const take = Math.min(need, remain);
    p.saved = Number(p.saved||0) + take;
    PROJ_TX.push({id:crypto.randomUUID(),date:today(),projectId:p.id,amount:take,envId});
    if(p.saved >= p.target){ p.done = true; }
    remain -= take;
  }
  // s‚Äôil reste du surplus, il reste dans l‚Äôenveloppe (env.totalIn d√©j√† compt√©)
}

/* ========= UI: Projets ========= */
function addProjet(){
  if(!SAV_ENV.length) return alert("Cr√©e d'abord une enveloppe d‚Äô√©pargne.");
  const envId = $("projEnv").value;
  const name = ($("projNom").value||"").trim();
  const target = Number(($("projPrix").value||0));
  if(!name || !target) return alert("Nom et objectif requis.");
  PROJ.push({id:crypto.randomUUID(),name,envId,target,saved:0,done:false});
  $("projNom").value=""; $("projPrix").value="";
  persist(); renderEpargneAll();
}

function delProjet(id){
  PROJ = PROJ.filter(p=>p.id!==id);
  PROJ_TX = PROJ_TX.filter(t=>t.projectId!==id);
  persist(); renderEpargneAll();
}

/* ========= Rendering ========= */
function renderBudgetAll(){
  // top tags
  $("nowMonth").textContent = new Date().toLocaleString("fr-DZ",{month:"long",year:"numeric"});
  $("txDate").value = today();

  // revenus
  $("salaireAffiche").innerHTML =
    `üí∞ Salaire : ${fmt(SALAIRE)}<br>‚ûï Revenus suppl√©mentaires : ${fmt(REVENUS_SUPP)}<br>üìä Total disponible : ${fmt(totalRevenus())}`;
  $("dashRevenus").textContent = fmt(totalRevenus());

  // d√©penses env
  const sb = spentByCatMonth(ymNow());
  $("depBody").innerHTML = DEP_ENV.map(e=>`
    <tr>
      <td>${e.name}</td>
      <td class="right">${fmt(e.budget||0)}</td>
      <td class="right"><button class="danger" onclick="delDepenseEnv('${e.id}')">Suppr.</button></td>
    </tr>
  `).join("");
  $("depTotal").textContent = just(sumDepBudgets());
  $("dashDepBudg").textContent = fmt(sumDepBudgets());

  // select pour d√©penses
  $("txCat").innerHTML = DEP_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");

  // d√©penses historiques
  $("txBody").innerHTML = DEP_TX.slice().reverse().map(t=>{
    const c = DEP_ENV.find(x=>x.id===t.catId);
    return `<tr><td>${t.date||"‚Äî"}</td><td>${c?c.name:"‚Äî"}</td><td>${t.note||""}</td><td class="right">${fmt(t.amount)}</td></tr>`;
  }).join("");

  // dashboard calculs
  const spent = totalDepenseMonth(ymNow());
  const theo  = theoSave(ymNow());
  const savTot= totalSavAlloue();
  const left  = leftToAllocate(ymNow());
  $("dashDepense").textContent = fmt(spent);
  $("dashTheoSave").textContent = fmt(theo);
  $("dashSavAlloue").textContent = fmt(savTot);
  $("dashLeft").textContent = fmt(left);
  const ratio = totalRevenus() ? Math.min(100, Math.round((spent/totalRevenus())*100)) : 0;
  $("barSpent").style.width = ratio+"%";

  // √âpargne enveloppes
  $("savBody").innerHTML = SAV_ENV.map(e=>`
    <tr>
      <td>${e.name}</td>
      <td class="right">${fmt(e.totalIn||0)}</td>
      <td class="right"><button class="danger" onclick="delSavEnv('${e.id}')">Suppr.</button></td>
    </tr>
  `).join("");
  $("savTotal").textContent = just(totalSavAlloue());
  $("savSelect").innerHTML = SAV_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");

  // ‚Äúprojection‚Äù rapide = (theoSave √ó 12) indicatif
  // (tu peux ajouter un tableau annuel si tu veux ici)
}

function renderEpargneAll(){
  // select d‚Äôenveloppes pour projet
  $("projEnv").innerHTML = SAV_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
  // liste projets
  $("projBody").innerHTML = PROJ.map(p=>{
    const env = SAV_ENV.find(e=>e.id===p.envId);
    const pct = p.target ? Math.min(100, Math.round((Number(p.saved||0)/Number(p.target))*100)) : 0;
    const status = (p.done || p.saved>=p.target)
      ? `<span class="success">Atteint ‚úÖ</span>`
      : `${fmt(p.saved||0)} / ${fmt(p.target)}`;
    return `
      <tr>
        <td>${p.name}</td>
        <td>${env?env.name:"‚Äî"}</td>
        <td class="right">${fmt(p.target)}</td>
        <td class="right">${fmt(p.saved||0)}</td>
        <td>
          <div class="bar"><i style="width:${pct}%"></i></div>
          <div class="muted">${pct}%</div>
        </td>
        <td class="right">
          <button class="danger" onclick="delProjet('${p.id}')">Suppr.</button>
        </td>
      </tr>
    `;
  }).join("");
}

/* ========= Boot ========= */
function renderAll(){ renderBudgetAll(); renderEpargneAll(); }
renderAll();
</script>
</body>
</html>
