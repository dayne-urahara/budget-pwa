<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Budget & Épargne – auto-allocation + priorités</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#667085;--ring:#e5e7eb;--accent:#2563eb;--good:#16a34a;--bad:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{background:#111827;color:#fff;padding:16px}
  header h1{margin:0;font-size:20px}
  nav{display:flex;background:#1f2937}
  nav button{flex:1;padding:12px 10px;border:none;background:#1f2937;color:#fff;cursor:pointer;font-size:16px}
  nav button.active{background:#0b1220;font-weight:600}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .page{display:none}.page.active{display:block}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  h2{margin:0 0 10px 0;font-size:18px}
  input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);font-size:16px;background:#fff}
  button.btn{border:none;background:var(--accent);color:#fff;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1}
  .muted{color:var(--muted);font-size:14px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{border-bottom:1px dashed #e5e7eb;padding:8px;text-align:left;vertical-align:top}
  .right{text-align:right}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px}
  .success{color:var(--good);font-weight:600}
  .danger{background:var(--bad);color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer}
  .ghost{background:#0b1220;color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer}
  .bar{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;background:#22c55e;width:0%}
  .tag{padding:2px 8px;border-radius:999px;font-size:12px;background:#f1f5f9}
  .prio{display:flex;gap:6px}
  .prio button{padding:6px 8px;border-radius:8px}
</style>
</head>
<body>
<header><h1>Budget & Épargne – auto-allocation + priorités</h1></header>
<nav>
  <button id="btnBudget" class="active" onclick="showPage('budget')">💰 Budget</button>
  <button id="btnEpargne" onclick="showPage('epargne')">📊 Épargne & Projets</button>
</nav>

<div class="wrap">
  <!-- PAGE BUDGET -->
  <div id="budget" class="page active">
    <div class="grid">
      <div class="card">
        <h2>1) Revenus</h2>
        <div class="row">
          <input id="salaireInput" type="number" inputmode="decimal" placeholder="Salaire mensuel (DZD)"/>
          <button class="btn" onclick="saveSalaire()">Enregistrer</button>
        </div>
        <div class="row">
          <input id="revenuInput" type="number" inputmode="decimal" placeholder="Autre revenu ponctuel (DZD)"/>
          <button class="btn" onclick="addRevenu()">Ajouter revenu</button>
        </div>
        <p id="revenusInfo" class="muted"></p>
      </div>

      <div class="card">
        <h2>2) Enveloppes d’ÉPARGNE</h2>
        <div class="row">
          <input id="savNom" placeholder="Nom (Aménagement, Voyage, Sécurité, Or…)"/>
          <button class="btn" onclick="addSavEnv()">Créer enveloppe</button>
        </div>
        <table class="table">
          <thead><tr><th>Enveloppe</th><th class="right">Total versé</th><th></th></tr></thead>
          <tbody id="savBody"></tbody>
        </table>
        <p><span class="pill">Total épargne versée : <span id="savTotal">0</span> DZD</span></p>

        <h3 style="margin-top:12px">Versement → auto-répartition vers projets liés</h3>
        <div class="row">
          <select id="savSelect"></select>
          <input id="savVersement" type="number" inputmode="decimal" placeholder="Montant (DZD)"/>
          <button class="btn" onclick="verserEpargne()">Verser & répartir</button>
        </div>
        <p class="muted">La répartition respecte **l’ordre de priorité** des projets de l’enveloppe (le premier en haut est servi d’abord).</p>
      </div>

      <div class="card">
        <h2>3) Enveloppes de DÉPENSES (facultatif)</h2>
        <div class="row">
          <input id="depNom" placeholder="Nom (Courses, Véhicule, Scolaire…)"/>
          <input id="depMontant" type="number" inputmode="decimal" placeholder="Budget mensuel (DZD)"/>
          <button class="btn" onclick="addDepenseEnv()">Ajouter</button>
        </div>
        <table class="table">
          <thead><tr><th>Catégorie</th><th class="right">Budget</th><th></th></tr></thead>
          <tbody id="depBody"></tbody>
        </table>
        <p><span class="pill">Total dépenses budgétées : <span id="depTotal">0</span> DZD</span></p>
      </div>

      <div class="card">
        <h2>4) Dashboard</h2>
        <p class="muted"><span class="tag" id="nowMonth"></span></p>
        <p>Total revenus : <strong id="dashRevenus">—</strong></p>
        <p>Total dépenses budgétées : <strong id="dashDepBudg">—</strong></p>
        <p>Épargne versée : <strong id="dashSavAlloue">—</strong></p>
        <p>Reste indicatif (revenus − budgets − épargne versée) : <strong id="dashLeft">—</strong></p>
        <div class="bar"><i id="barSpent"></i></div>
        <p class="muted">Barre = épargne versée en % des revenus.</p>
      </div>
    </div>
  </div>

  <!-- PAGE ÉPARGNE & PROJETS -->
  <div id="epargne" class="page">
    <div class="card">
      <h2>Projets par enveloppe (priorités haut/bas)</h2>
      <div class="row">
        <select id="projEnv"></select>
        <input id="projNom" placeholder="Nom du projet (ex: Meuble salle de bain)"/>
      </div>
      <div class="row">
        <input id="projPrix" type="number" inputmode="decimal" placeholder="Objectif (DZD)"/>
        <button class="btn" onclick="addProjet()">Créer projet</button>
      </div>
      <p class="muted">Réorganise l’ordre des projets (⬆️⬇️) pour changer **la priorité de financement**. La progression passe en vert ✅ dès que l’objectif est atteint.</p>

      <table class="table">
        <thead><tr><th>Projet</th><th>Enveloppe</th><th class="right">Objectif</th><th class="right">Épargné</th><th>Progression</th><th>Priorité</th><th></th></tr></thead>
        <tbody id="projBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ========= State ========= */
const $ = id => document.getElementById(id);
const fmt = n => new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0))+" DZD";
const just = n => new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0));

let SALAIRE = Number(localStorage.getItem("SALAIRE")||0);
let REVENUS_SUPP = Number(localStorage.getItem("REVENUS_SUPP")||0);

// Épargne – enveloppes & versements
let SAV_ENV = JSON.parse(localStorage.getItem("SAV_ENV")||"[]");  // {id,name,totalIn}
let SAV_TX  = JSON.parse(localStorage.getItem("SAV_TX")||"[]");   // {id,date,envId,amount}

// Projets liés à enveloppes (avec priorité)
let PROJ    = JSON.parse(localStorage.getItem("PROJ")||"[]");     // {id,name,envId,target,saved,done,priority}
let PROJ_TX = JSON.parse(localStorage.getItem("PROJ_TX")||"[]");  // {id,date,projectId,amount,envId}

// Dépenses budgétées (facultatif)
let DEP_ENV = JSON.parse(localStorage.getItem("DEP_ENV")||"[]");  // {id,name,budget}

/* ========= Persist ========= */
function persist(){
  localStorage.setItem("SALAIRE",SALAIRE);
  localStorage.setItem("REVENUS_SUPP",REVENUS_SUPP);
  localStorage.setItem("SAV_ENV",JSON.stringify(SAV_ENV));
  localStorage.setItem("SAV_TX",JSON.stringify(SAV_TX));
  localStorage.setItem("PROJ",JSON.stringify(PROJ));
  localStorage.setItem("PROJ_TX",JSON.stringify(PROJ_TX));
  localStorage.setItem("DEP_ENV",JSON.stringify(DEP_ENV));
}

/* ========= Navigation ========= */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  $(id).classList.add("active");
  (id==="budget"?$("btnBudget"):$("btnEpargne")).classList.add("active");
}

/* ========= Calculs ========= */
function sumDepBudgets(){ return DEP_ENV.reduce((s,c)=>s+Number(c.budget||0),0); }
function totalRevenus(){ return (Number(SALAIRE)||0) + (Number(REVENUS_SUPP)||0); }
function totalSavAlloue(){ return SAV_ENV.reduce((s,e)=> s + Number(e.totalIn||0), 0); }

/* ========= Revenus ========= */
function saveSalaire(){
  const v = Number(($("salaireInput").value||0));
  if(!v){ alert("Salaire invalide."); return; }
  SALAIRE=v; $("salaireInput").value="";
  persist(); renderAll();
}
function addRevenu(){
  const v = Number(($("revenuInput").value||0));
  if(!v){ alert("Montant de revenu invalide."); return; }
  REVENUS_SUPP += v; $("revenuInput").value="";
  persist(); renderAll();
}

/* ========= Épargne – enveloppes ========= */
function addSavEnv(){
  const name = ($("savNom").value||"").trim();
  if(!name){ alert("Nom d’enveloppe requis."); return; }
  SAV_ENV.push({id:crypto.randomUUID(),name,totalIn:0});
  $("savNom").value="";
  persist(); renderAll();
}
function delSavEnv(id){
  // Supprime enveloppe + versements + projets & tx liés
  SAV_TX = SAV_TX.filter(t=>t.envId!==id);
  const projIds = PROJ.filter(p=>p.envId===id).map(p=>p.id);
  PROJ_TX = PROJ_TX.filter(x=> !projIds.includes(x.projectId));
  PROJ = PROJ.filter(p=>p.envId!==id);
  SAV_ENV = SAV_ENV.filter(e=>e.id!==id);
  persist(); renderAll();
}

/* — Versement + auto-répartition selon priorité — */
function verserEpargne(){
  if(!SAV_ENV.length){ alert("Crée d’abord une enveloppe d’épargne."); return; }
  const envId = $("savSelect").value;
  const amount = Number(($("savVersement").value||0));
  if(!amount){ alert("Montant invalide."); return; }

  // log enveloppe
  SAV_TX.push({id:crypto.randomUUID(),date:new Date().toISOString().slice(0,10),envId,amount});
  const env = SAV_ENV.find(e=>e.id===envId);
  env.totalIn = Number(env.totalIn||0) + amount;

  // auto-allocate aux projets non terminés triés par priority ASC
  ensurePriorities(envId);
  let remain = amount;
  const list = PROJ
    .filter(p=>p.envId===envId && !p.done)
    .sort((a,b)=> (a.priority??0) - (b.priority??0));

  for(const p of list){
    if(remain<=0) break;
    const need = Math.max(0, Number(p.target||0) - Number(p.saved||0));
    if(need<=0){ p.done=true; continue; }
    const take = Math.min(need, remain);
    p.saved = Number(p.saved||0) + take;
    PROJ_TX.push({id:crypto.randomUUID(),date:new Date().toISOString().slice(0,10),projectId:p.id,amount:take,envId});
    if(p.saved >= p.target){ p.done = true; }
    remain -= take;
  }
  $("savVersement").value="";
  persist(); renderAll();
}

/* ========= Projets (création + priorités) ========= */
function getNextPriority(envId){
  const ps = PROJ.filter(p=>p.envId===envId);
  if(!ps.length) return 0;
  return Math.max(...ps.map(p=> (p.priority??0))) + 1;
}
function ensurePriorities(envId){
  const ps = PROJ.filter(p=>p.envId===envId);
  // si certains n’ont pas de priority, on normalise en séquence 0..n-1 selon l’ordre actuel d’affichage
  if (ps.some(p=>p.priority===undefined)){
    ps.sort((a,b)=> (a.priority??Number.MAX_SAFE_INTEGER) - (b.priority??Number.MAX_SAFE_INTEGER));
    ps.forEach((p,i)=> p.priority=i);
  } else {
    // aussi : compacter (éviter 0,2,5…)
    ps.sort((a,b)=> (a.priority - b.priority));
    ps.forEach((p,i)=> p.priority=i);
  }
}
function addProjet(){
  if(!SAV_ENV.length){ alert("Crée d’abord une enveloppe d’épargne."); return; }
  const envId = $("projEnv").value;
  const name = ($("projNom").value||"").trim();
  const target = Number(($("projPrix").value||0));
  if(!name || !target){ alert("Nom et objectif requis."); return; }
  const prio = getNextPriority(envId);
  PROJ.push({id:crypto.randomUUID(),name,envId,target,saved:0,done:false,priority:prio});
  $("projNom").value=""; $("projPrix").value="";
  persist(); renderAll();
}
function delProjet(id){
  const envId = PROJ.find(p=>p.id===id)?.envId;
  PROJ = PROJ.filter(p=>p.id!==id);
  PROJ_TX = PROJ_TX.filter(t=>t.projectId!==id);
  if(envId) ensurePriorities(envId);
  persist(); renderAll();
}
function moveProject(id, dir){ // dir = -1 (up) | +1 (down)
  const p = PROJ.find(x=>x.id===id); if(!p) return;
  ensurePriorities(p.envId);
  const siblings = PROJ.filter(x=>x.envId===p.envId).sort((a,b)=>a.priority-b.priority);
  const idx = siblings.findIndex(x=>x.id===id);
  const swapIdx = idx + dir;
  if (swapIdx<0 || swapIdx>=siblings.length) return; // rien à faire
  // swap priorities
  const a = siblings[idx], b = siblings[swapIdx];
  const tmp = a.priority; a.priority = b.priority; b.priority = tmp;
  persist(); renderAll();
}

/* ========= Dépenses budgétées (facultatif) ========= */
function addDepenseEnv(){
  const name = ($("depNom").value||"").trim();
  const bud  = Number(($("depMontant").value||0));
  if(!name || !bud){ alert("Nom et budget requis."); return; }
  DEP_ENV.push({id:crypto.randomUUID(),name,budget:bud});
  $("depNom").value=""; $("depMontant").value="";
  persist(); renderAll();
}
function delDepenseEnv(id){
  DEP_ENV = DEP_ENV.filter(e=>e.id!==id);
  persist(); renderAll();
}

/* ========= Rendering ========= */
function renderBudget(){
  $("nowMonth").textContent = new Date().toLocaleString("fr-DZ",{month:"long",year:"numeric"});
  $("revenusInfo").innerHTML = `💰 Salaire : ${fmt(SALAIRE)}<br>➕ Revenus supplémentaires : ${fmt(REVENUS_SUPP)}<br>📊 Total revenus : ${fmt(totalRevenus())}`;

  // Épargne – enveloppes
  $("savBody").innerHTML = SAV_ENV.map(e=>`
    <tr>
      <td>${e.name}</td>
      <td class="right">${fmt(e.totalIn||0)}</td>
      <td class="right"><button class="danger" onclick="delSavEnv('${e.id}')">Suppr.</button></td>
    </tr>
  `).join("");
  $("savTotal").textContent = just(totalSavAlloue());
  $("savSelect").innerHTML = SAV_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");

  // Dépenses budgétées
  $("depBody").innerHTML = DEP_ENV.map(e=>`
    <tr>
      <td>${e.name}</td>
      <td class="right">${fmt(e.budget||0)}</td>
      <td class="right"><button class="danger" onclick="delDepenseEnv('${e.id}')">Suppr.</button></td>
    </tr>
  `).join("");
  $("depTotal").textContent = just(sumDepBudgets());

  // Dashboard simple
  $("dashRevenus").textContent = fmt(totalRevenus());
  $("dashDepBudg").textContent = fmt(sumDepBudgets());
  $("dashSavAlloue").textContent = fmt(totalSavAlloue());
  const left = Math.max(0, totalRevenus() - sumDepBudgets() - totalSavAlloue());
  $("dashLeft").textContent = fmt(left);
  const ratio = totalRevenus()? Math.min(100, Math.round((totalSavAlloue()/totalRevenus())*100)) : 0;
  $("barSpent").style.width = ratio + "%";
}

function renderEpargne(){
  $("projEnv").innerHTML = SAV_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");

  // Pour un affichage clair : trier globalement par enveloppe puis par priority
  const projSorted = PROJ.slice().sort((a,b)=>{
    const ea = SAV_ENV.find(e=>e.id===a.envId)?.name || "";
    const eb = SAV_ENV.find(e=>e.id===b.envId)?.name || "";
    if (ea !== eb) return ea.localeCompare(eb);
    return (a.priority??0) - (b.priority??0);
  });

  $("projBody").innerHTML = projSorted.map(p=>{
    const env = SAV_ENV.find(e=>e.id===p.envId);
    const pct = p.target ? Math.min(100, Math.round((Number(p.saved||0)/Number(p.target))*100)) : 0;
    const status = (p.done || p.saved>=p.target)
      ? `<span class="success">Atteint ✅</span>`
      : `${fmt(p.saved||0)} / ${fmt(p.target)}`;
    return `
      <tr>
        <td>${p.name}</td>
        <td>${env?env.name:"—"}</td>
        <td class="right">${fmt(p.target)}</td>
        <td class="right">${fmt(p.saved||0)}</td>
        <td>
          <div class="bar"><i style="width:${pct}%"></i></div>
          <div class="muted">${pct}%</div>
        </td>
        <td>
          <div class="prio">
            <button class="ghost" onclick="moveProject('${p.id}', -1)">⬆️ Haut</button>
            <button class="ghost" onclick="moveProject('${p.id}', 1)">⬇️ Bas</button>
          </div>
          <div class="muted">rang: ${p.priority??0}</div>
        </td>
        <td class="right"><button class="danger" onclick="delProjet('${p.id}')">Suppr.</button></td>
      </tr>
    `;
  }).join("");
}

function renderAll(){ renderBudget(); renderEpargne(); }

// Boot : compat pour anciens projets (sans priority)
(function initPriorities(){
  const envIds = [...new Set(PROJ.map(p=>p.envId))];
  envIds.forEach(ensurePriorities);
})();
renderAll();
</script>
</body>
</html>
