<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Budget & √âpargne ‚Äì drag & drop + projection</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#667085;--ring:#e5e7eb;--accent:#2563eb;--good:#16a34a;--bad:#ef4444;--warn:#f59e0b}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{background:#111827;color:#fff;padding:16px}
  header h1{margin:0;font-size:20px}
  nav{display:flex;background:#1f2937}
  nav button{flex:1;padding:12px 10px;border:none;background:#1f2937;color:#fff;cursor:pointer;font-size:16px}
  nav button.active{background:#0b1220;font-weight:600}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .page{display:none}.page.active{display:block}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  h2{margin:0 0 10px 0;font-size:18px}
  h3{margin:10px 0 8px 0;font-size:16px}
  input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--ring);font-size:16px;background:#fff}
  button.btn{border:none;background:var(--accent);color:#fff;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1}
  .muted{color:var(--muted);font-size:14px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{border-bottom:1px dashed #e5e7eb;padding:8px;text-align:left;vertical-align:top}
  .right{text-align:right}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px}
  .success{color:var(--good);font-weight:600}
  .danger{background:var(--bad);color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer}
  .ghost{background:#0b1220;color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer}
  .bar{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;background:#22c55e;width:0%}
  .tag{padding:2px 8px;border-radius:999px;font-size:12px;background:#f1f5f9}
  .prio{display:flex;gap:6px}
  .prio button{padding:6px 8px;border-radius:8px}
  /* Drag & Drop styles */
  tbody.dropzone{border:2px dashed #cbd5e1;border-radius:12px}
  tr.dragging{opacity:.5}
  tr.drop-hint{outline:2px solid #a5b4fc}
  .envHeader{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:8px;margin-top:10px}
  .hint{padding:10px;border-radius:12px;background:#f8fafc;border:1px dashed #e2e8f0;font-size:14px}
  .warn{color:var(--warn);font-weight:600}
</style>
</head>
<body>
<header><h1>Budget & √âpargne ‚Äì drag & drop + projection</h1></header>
<nav>
  <button id="btnBudget" class="active" onclick="showPage('budget')">üí∞ Budget</button>
  <button id="btnEpargne" onclick="showPage('epargne')">üìä √âpargne & Projets</button>
</nav>

<div class="wrap">
  <!-- PAGE BUDGET -->
  <div id="budget" class="page active">
    <div class="grid">
      <div class="card">
        <h2>1) Revenus</h2>
        <div class="row">
          <input id="salaireInput" type="number" inputmode="decimal" placeholder="Salaire mensuel (DZD)"/>
          <button class="btn" onclick="saveSalaire()">Enregistrer</button>
        </div>
        <div class="row">
          <input id="revenuInput" type="number" inputmode="decimal" placeholder="Autre revenu ponctuel (DZD)"/>
          <button class="btn" onclick="addRevenu()">Ajouter revenu</button>
        </div>
        <p id="revenusInfo" class="muted"></p>
      </div>

      <div class="card">
        <h2>2) Enveloppes d‚Äô√âPARGNE</h2>
        <div class="row">
          <input id="savNom" placeholder="Nom (Am√©nagement, Voyage, S√©curit√©, Or‚Ä¶)"/>
          <button class="btn" onclick="addSavEnv()">Cr√©er enveloppe</button>
        </div>
        <table class="table">
          <thead><tr><th>Enveloppe</th><th class="right">Total vers√©</th><th></th></tr></thead>
          <tbody id="savBody"></tbody>
        </table>
        <p><span class="pill">Total √©pargne vers√©e : <span id="savTotal">0</span> DZD</span></p>

        <h3 style="margin-top:12px">Versement ‚Üí auto-r√©partition vers projets li√©s</h3>
        <div class="row">
          <select id="savSelect"></select>
          <input id="savVersement" type="number" inputmode="decimal" placeholder="Montant (DZD)"/>
          <button class="btn" onclick="verserEpargne()">Verser & r√©partir</button>
        </div>
        <p class="muted">La r√©partition respecte **l‚Äôordre de priorit√©** des projets de l‚Äôenveloppe (drag & drop ou ‚¨ÜÔ∏è‚¨áÔ∏è).</p>
      </div>

      <div class="card">
        <h2>3) Enveloppes de D√âPENSES (facultatif)</h2>
        <div class="row">
          <input id="depNom" placeholder="Nom (Courses, V√©hicule, Scolaire‚Ä¶)"/>
          <input id="depMontant" type="number" inputmode="decimal" placeholder="Budget mensuel (DZD)"/>
          <button class="btn" onclick="addDepenseEnv()">Ajouter</button>
        </div>
        <table class="table">
          <thead><tr><th>Cat√©gorie</th><th class="right">Budget</th><th></th></tr></thead>
          <tbody id="depBody"></tbody>
        </table>
        <p><span class="pill">Total d√©penses budg√©t√©es : <span id="depTotal">0</span> DZD</span></p>
      </div>

      <div class="card">
        <h2>4) Dashboard</h2>
        <p class="muted"><span class="tag" id="nowMonth"></span></p>
        <p>Total revenus : <strong id="dashRevenus">‚Äî</strong></p>
        <p>Total d√©penses budg√©t√©es : <strong id="dashDepBudg">‚Äî</strong></p>
        <p>√âpargne vers√©e : <strong id="dashSavAlloue">‚Äî</strong></p>
        <p>Reste indicatif (revenus ‚àí budgets ‚àí √©pargne vers√©e) : <strong id="dashLeft">‚Äî</strong></p>
        <div class="bar"><i id="barSpent"></i></div>
        <p class="muted">Barre = √©pargne vers√©e en % des revenus.</p>
      </div>
    </div>
  </div>

  <!-- PAGE √âPARGNE & PROJETS -->
  <div id="epargne" class="page">
    <div class="card">
      <h2>Projets par enveloppe (drag & drop + priorit√©s)</h2>
      <div class="row">
        <select id="projEnv"></select>
        <input id="projNom" placeholder="Nom du projet (ex: Meuble salle de bain)"/>
      </div>
      <div class="row">
        <input id="projPrix" type="number" inputmode="decimal" placeholder="Objectif (DZD)"/>
        <button class="btn" onclick="addProjet()">Cr√©er projet</button>
      </div>
      <p class="muted">R√©organise par **glisser-d√©poser** (ou ‚¨ÜÔ∏è‚¨áÔ∏è) pour changer l‚Äôordre de financement. Le projet **en haut** est servi **en premier**.</p>

      <!-- Groupes d‚Äôenveloppes + tables projets -->
      <div id="projGroups"></div>
    </div>

    <div class="card">
      <h2>Projection 12 mois (par enveloppe & projets)</h2>
      <div class="row">
        <label for="avgMonths" class="muted">Moyenne mensuelle bas√©e sur :</label>
        <select id="avgMonths">
          <option value="3" selected>3 derniers mois</option>
          <option value="6">6 derniers mois</option>
          <option value="12">12 derniers mois</option>
        </select>
        <button class="btn" onclick="renderProjection()">Recalculer</button>
      </div>
      <div id="projectionWrap"></div>
      <div class="hint" id="compassBox">Conseils en fonction de tes versements et objectifs‚Ä¶</div>
    </div>
  </div>
</div>

<script>
/* ========= State ========= */
const $ = id => document.getElementById(id);
const fmt = n => new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0))+" DZD";
const just = n => new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0));

let SALAIRE = Number(localStorage.getItem("SALAIRE")||0);
let REVENUS_SUPP = Number(localStorage.getItem("REVENUS_SUPP")||0);

// √âpargne ‚Äì enveloppes & versements
let SAV_ENV = JSON.parse(localStorage.getItem("SAV_ENV")||"[]");  // {id,name,totalIn}
let SAV_TX  = JSON.parse(localStorage.getItem("SAV_TX")||"[]");   // {id,date,envId,amount}

// Projets li√©s √† enveloppes (avec priority)
let PROJ    = JSON.parse(localStorage.getItem("PROJ")||"[]");     // {id,name,envId,target,saved,done,priority}
let PROJ_TX = JSON.parse(localStorage.getItem("PROJ_TX")||"[]");  // {id,date,projectId,amount,envId}

// D√©penses budg√©t√©es (facultatif)
let DEP_ENV = JSON.parse(localStorage.getItem("DEP_ENV")||"[]");  // {id,name,budget}

/* ========= Persist ========= */
function persist(){
  localStorage.setItem("SALAIRE",SALAIRE);
  localStorage.setItem("REVENUS_SUPP",REVENUS_SUPP);
  localStorage.setItem("SAV_ENV",JSON.stringify(SAV_ENV));
  localStorage.setItem("SAV_TX",JSON.stringify(SAV_TX));
  localStorage.setItem("PROJ",JSON.stringify(PROJ));
  localStorage.setItem("PROJ_TX",JSON.stringify(PROJ_TX));
  localStorage.setItem("DEP_ENV",JSON.stringify(DEP_ENV));
}

/* ========= Navigation ========= */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  $(id).classList.add("active");
  (id==="budget"?$("btnBudget"):$("btnEpargne")).classList.add("active");
}

/* ========= Calculs de base ========= */
function sumDepBudgets(){ return DEP_ENV.reduce((s,c)=>s+Number(c.budget||0),0); }
function totalRevenus(){ return (Number(SALAIRE)||0) + (Number(REVENUS_SUPP)||0); }
function totalSavAlloue(){ return SAV_ENV.reduce((s,e)=> s + Number(e.totalIn||0), 0); }

/* ========= Revenus ========= */
function saveSalaire(){
  const v = Number(($("salaireInput").value||0));
  if(!v){ alert("Salaire invalide."); return; }
  SALAIRE=v; $("salaireInput").value="";
  persist(); renderAll();
}
function addRevenu(){
  const v = Number(($("revenuInput").value||0));
  if(!v){ alert("Montant de revenu invalide."); return; }
  REVENUS_SUPP += v; $("revenuInput").value="";
  persist(); renderAll();
}

/* ========= √âpargne ‚Äì enveloppes ========= */
function addSavEnv(){
  const name = ($("savNom").value||"").trim();
  if(!name){ alert("Nom d‚Äôenveloppe requis."); return; }
  SAV_ENV.push({id:crypto.randomUUID(),name,totalIn:0});
  $("savNom").value="";
  persist(); renderAll();
}
function delSavEnv(id){
  // Supprime enveloppe + versements + projets & tx li√©s
  SAV_TX = SAV_TX.filter(t=>t.envId!==id);
  const projIds = PROJ.filter(p=>p.envId===id).map(p=>p.id);
  PROJ_TX = PROJ_TX.filter(x=> !projIds.includes(x.projectId));
  PROJ = PROJ.filter(p=>p.envId!==id);
  SAV_ENV = SAV_ENV.filter(e=>e.id!==id);
  persist(); renderAll();
}

/* ‚Äî Versement + auto-r√©partition selon priorit√© ‚Äî */
function verserEpargne(){
  if(!SAV_ENV.length){ alert("Cr√©e d‚Äôabord une enveloppe d‚Äô√©pargne."); return; }
  const envId = $("savSelect").value;
  const amount = Number(($("savVersement").value||0));
  if(!amount){ alert("Montant invalide."); return; }

  // log enveloppe
  const today = new Date().toISOString().slice(0,10);
  SAV_TX.push({id:crypto.randomUUID(),date:today,envId,amount});
  const env = SAV_ENV.find(e=>e.id===envId);
  env.totalIn = Number(env.totalIn||0) + amount;

  // auto-allocate aux projets non termin√©s tri√©s par priority ASC
  ensurePriorities(envId);
  let remain = amount;
  const list = PROJ
    .filter(p=>p.envId===envId && !p.done)
    .sort((a,b)=> (a.priority??0) - (b.priority??0));

  for(const p of list){
    if(remain<=0) break;
    const need = Math.max(0, Number(p.target||0) - Number(p.saved||0));
    if(need<=0){ p.done=true; continue; }
    const take = Math.min(need, remain);
    p.saved = Number(p.saved||0) + take;
    PROJ_TX.push({id:crypto.randomUUID(),date:today,projectId:p.id,amount:take,envId});
    if(p.saved >= p.target){ p.done = true; }
    remain -= take;
  }
  $("savVersement").value="";
  persist(); renderAll();
}

/* ========= Projets (cr√©ation + priorit√©s + drag & drop) ========= */
function getNextPriority(envId){
  const ps = PROJ.filter(p=>p.envId===envId);
  if(!ps.length) return 0;
  return Math.max(...ps.map(p=> (p.priority??0))) + 1;
}
function ensurePriorities(envId){
  const ps = PROJ.filter(p=>p.envId===envId);
  if (ps.some(p=>p.priority===undefined)){
    ps.sort((a,b)=> (a.priority??Number.MAX_SAFE_INTEGER) - (b.priority??Number.MAX_SAFE_INTEGER));
    ps.forEach((p,i)=> p.priority=i);
  } else {
    ps.sort((a,b)=> (a.priority - b.priority));
    ps.forEach((p,i)=> p.priority=i);
  }
}
function addProjet(){
  if(!SAV_ENV.length){ alert("Cr√©e d‚Äôabord une enveloppe d‚Äô√©pargne."); return; }
  const envId = $("projEnv").value;
  const name = ($("projNom").value||"").trim();
  const target = Number(($("projPrix").value||0));
  if(!name || !target){ alert("Nom et objectif requis."); return; }
  const prio = getNextPriority(envId);
  PROJ.push({id:crypto.randomUUID(),name,envId,target,saved:0,done:false,priority:prio});
  $("projNom").value=""; $("projPrix").value="";
  persist(); renderAll();
}
function delProjet(id){
  const envId = PROJ.find(p=>p.id===id)?.envId;
  PROJ = PROJ.filter(p=>p.id!==id);
  PROJ_TX = PROJ_TX.filter(t=>t.projectId!==id);
  if(envId) ensurePriorities(envId);
  persist(); renderAll();
}
function moveProject(id, dir){ // dir = -1 (up) | +1 (down)
  const p = PROJ.find(x=>x.id===id); if(!p) return;
  ensurePriorities(p.envId);
  const sib = PROJ.filter(x=>x.envId===p.envId).sort((a,b)=>a.priority-b.priority);
  const idx = sib.findIndex(x=>x.id===id);
  const j = idx + dir;
  if (j<0 || j>=sib.length) return;
  const a=sib[idx], b=sib[j];
  const tmp=a.priority; a.priority=b.priority; b.priority=tmp;
  persist(); renderAll();
}

/* ---- Drag & Drop intra-enveloppe ---- */
let dragState = { id:null, envId:null };

function attachDnD(){
  // pour chaque tbody.dropzone, on branche les handlers
  document.querySelectorAll('tbody.dropzone').forEach(tbody=>{
    tbody.addEventListener('dragover', (e)=>{ e.preventDefault(); const tr = e.target.closest('tr[data-id]'); if(tr) tr.classList.add('drop-hint'); });
    tbody.addEventListener('dragleave', (e)=>{ const tr = e.target.closest('tr[data-id]'); if(tr) tr.classList.remove('drop-hint'); });
    tbody.addEventListener('drop', (e)=>{
      e.preventDefault();
      const zone = e.currentTarget;
      if (!dragState.id || dragState.envId !== zone.dataset.envId) return; // on n‚Äôautorise que dans la m√™me enveloppe
      const rows = Array.from(zone.querySelectorAll('tr[data-id]'));
      const targetRow = e.target.closest('tr[data-id]');
      rows.forEach(r=>r.classList.remove('drop-hint'));
      // on calcule la nouvelle position : on ins√®re avant targetRow (si existe), sinon √† la fin
      const draggedId = dragState.id;
      const orderIds = rows.map(r=>r.dataset.id).filter(x=>x!==draggedId);
      if (targetRow) {
        const idx = rows.findIndex(r=>r===targetRow);
        orderIds.splice(idx, 0, draggedId);
      } else {
        orderIds.push(draggedId);
      }
      // met √† jour les priorities selon l'ordre DOM calcul√©
      orderIds.forEach((pid, i)=>{
        const p = PROJ.find(x=>x.id===pid);
        if (p) p.priority = i;
      });
      persist(); renderAll();
      dragState.id=null; dragState.envId=null;
    });
  });

  // chaque ligne projet devient draggable
  document.querySelectorAll('tr[data-id]').forEach(tr=>{
    tr.setAttribute('draggable','true');
    tr.addEventListener('dragstart', ()=>{
      tr.classList.add('dragging');
      dragState.id = tr.dataset.id;
      dragState.envId = tr.dataset.envId;
    });
    tr.addEventListener('dragend', ()=>{
      tr.classList.remove('dragging');
    });
  });
}

/* ========= Projection 12 mois ========= */
function addMonths(date, n){
  const d = new Date(date.getFullYear(), date.getMonth()+n, 1);
  // garder la fin de mois simple : on affiche AAAA-MM
  return d;
}
function monthKey(dt){ return dt.toISOString().slice(0,7); }
function monthsBack(n){
  const arr=[]; const d=new Date();
  for(let i=0;i<n;i++){ const dd=new Date(d.getFullYear(), d.getMonth()-i, 1); arr.push(monthKey(dd)); }
  return arr; // [YYYY-MM (courant), -1, ...]
}
function avgMonthlyForEnv(envId, monthsWindow){
  const keys = monthsBack(monthsWindow);
  const sums = {};
  for(const k of keys) sums[k]=0;
  for(const t of SAV_TX){
    if(t.envId!==envId) continue;
    const k = (t.date||"").slice(0,7);
    if (keys.includes(k)) sums[k] += Number(t.amount||0);
  }
  const total = keys.reduce((s,k)=> s + (sums[k]||0), 0);
  return total / keys.length;
}

function computeProjectionData(monthsWindow){
  // retourne des lignes {envName, envId, avg, projectName, remaining, months, etaDate, withinYear, done}
  const rows=[];
  for(const env of SAV_ENV){
    const avg = avgMonthlyForEnv(env.id, monthsWindow);
    // l‚Äôordre = priorit√©
    const list = PROJ
      .filter(p=>p.envId===env.id)
      .sort((a,b)=>(a.priority??0)-(b.priority??0));
    let cursorMonth = 0; // cumul mois pour ETA s√©quentielle
    for(const p of list){
      const remaining = Math.max(0, Number(p.target||0)-Number(p.saved||0));
      if (remaining===0){
        rows.push({envName:env.name, envId:env.id, avg, projectName:p.name, remaining:0, months:0, etaDate:new Date(), withinYear:true, done:true});
        continue;
      }
      if (avg<=0){
        rows.push({envName:env.name, envId:env.id, avg, projectName:p.name, remaining, months:Infinity, etaDate:null, withinYear:false, done:false});
        continue;
      }
      const mNeeded = Math.ceil(remaining / avg);
      cursorMonth += mNeeded;
      const eta = addMonths(new Date(), cursorMonth);
      rows.push({envName:env.name, envId:env.id, avg, projectName:p.name, remaining, months:mNeeded, etaDate:eta, withinYear: cursorMonth<=12, done:false});
    }
  }
  return rows;
}

function renderProjection(){
  const win = Number(($("avgMonths").value||3));
  const rows = computeProjectionData(win);

  if(!rows.length){
    $("projectionWrap").innerHTML = `<p class="muted">Aucun projet ou enveloppe d‚Äô√©pargne pour l‚Äôinstant.</p>`;
    $("compassBox").textContent = "Ajoute une enveloppe d‚Äô√©pargne et au moins un projet pour voir la projection.";
    return;
  }

  // construire un tableau group√© par enveloppe
  const byEnv = {};
  for(const r of rows){
    if(!byEnv[r.envId]) byEnv[r.envId] = {name:r.envName, avg:r.avg, items:[]};
    byEnv[r.envId].items.push(r);
  }

  let html = "";
  for(const envId of Object.keys(byEnv)){
    const group = byEnv[envId];
    html += `
      <div class="envHeader"><strong>Enveloppe :</strong> ${group.name} ‚Äî <span class="muted">Moyenne mensuelle (${win} mois) :</span> <strong>${fmt(group.avg||0)}</strong></div>
      <table class="table">
        <thead><tr><th>Projet</th><th class="right">Restant</th><th class="right">Mois estim√©s</th><th>Date estim√©e</th><th>Statut</th></tr></thead>
        <tbody>
          ${
            group.items.map(it=>{
              const eta = it.etaDate ? it.etaDate.toLocaleString("fr-DZ",{year:"numeric", month:"long"}) : "‚Äî";
              let statut = "";
              if (it.done) statut = `<span class="success">Atteint ‚úÖ</span>`;
              else if (!isFinite(it.months)) statut = `<span class="warn">Aucun versement r√©cent</span>`;
              else statut = it.withinYear ? `<span class="success">‚â§ 12 mois</span>` : `<span class="muted">> 12 mois</span>`;
              return `<tr>
                <td>${it.projectName}</td>
                <td class="right">${fmt(it.remaining)}</td>
                <td class="right">${isFinite(it.months)? it.months : "‚àû"}</td>
                <td>${eta}</td>
                <td>${statut}</td>
              </tr>`;
            }).join("")
          }
        </tbody>
      </table>
    `;
  }
  $("projectionWrap").innerHTML = html;

  // Boussole simple
  const tips = [];
  // env sans versement
  const starved = Object.values(byEnv).filter(g=> (g.avg||0)===0 && g.items.some(i=>!i.done));
  if (starved.length){
    tips.push(`<div class="warn">Aucune moyenne de versement sur : ${starved.map(g=>`<strong>${g.name}</strong>`).join(", ")}. Fixe un versement mensuel minimal.</div>`);
  }
  // projets > 12 mois
  const longies = rows.filter(r=>!r.done && isFinite(r.months) && !r.withinYear);
  if (longies.length){
    tips.push(`<div>Plusieurs objectifs d√©passent 12 mois. Options : augmenter le versement des enveloppes concern√©es, ou remonter la priorit√© de projets plus strat√©giques.</div>`);
  }
  if (!tips.length){
    tips.push(`<div class="success">Cap OK : tes enveloppes et priorit√©s m√®nent √† des objectifs atteignables dans l‚Äôann√©e.</div>`);
  }
  $("compassBox").innerHTML = tips.map(t=>`<p>${t}</p>`).join("");
}

/* ========= Rendering ========= */
function renderBudget(){
  $("nowMonth").textContent = new Date().toLocaleString("fr-DZ",{month:"long",year:"numeric"});
  $("revenusInfo").innerHTML = `üí∞ Salaire : ${fmt(SALAIRE)}<br>‚ûï Revenus suppl√©mentaires : ${fmt(REVENUS_SUPP)}<br>üìä Total revenus : ${fmt(totalRevenus())}`;

  // √âpargne ‚Äì enveloppes
  $("savBody").innerHTML = SAV_ENV.map(e=>`
    <tr>
      <td>${e.name}</td>
      <td class="right">${fmt(e.totalIn||0)}</td>
      <td class="right"><button class="danger" onclick="delSavEnv('${e.id}')">Suppr.</button></td>
    </tr>
  `).join("");
  $("savTotal").textContent = just(totalSavAlloue());
  $("savSelect").innerHTML = SAV_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");

  // D√©penses budg√©t√©es
  $("depBody").innerHTML = DEP_ENV.map(e=>`
    <tr>
      <td>${e.name}</td>
      <td class="right">${fmt(e.budget||0)}</td>
      <td class="right"><button class="danger" onclick="delDepenseEnv('${e.id}')">Suppr.</button></td>
    </tr>
  `).join("");
  $("depTotal").textContent = just(sumDepBudgets());

  // Dashboard simple
  $("dashRevenus").textContent = fmt(totalRevenus());
  $("dashDepBudg").textContent = fmt(sumDepBudgets());
  $("dashSavAlloue").textContent = fmt(totalSavAlloue());
  const left = Math.max(0, totalRevenus() - sumDepBudgets() - totalSavAlloue());
  $("dashLeft").textContent = fmt(left);
  const ratio = totalRevenus()? Math.min(100, Math.round((totalSavAlloue()/totalRevenus())*100)) : 0;
  $("barSpent").style.width = ratio + "%";
}

/* --- Rendu projets group√©s par enveloppe avec DnD --- */
function renderProjectsGrouped(){
  // groupe par enveloppe
  const groups = {};
  for(const e of SAV_ENV){ groups[e.id] = { name:e.name, id:e.id, items:[] }; }
  for(const p of PROJ){ if(groups[p.envId]) groups[p.envId].items.push(p); }

  // tri par priorit√© et rendu
  let html = "";
  const envIds = Object.keys(groups).sort((a,b)=> groups[a].name.localeCompare(groups[b].name));
  envIds.forEach(envId=>{
    // normalise priorit√©s
    ensurePriorities(envId);
    const g = groups[envId];
    const items = g.items.slice().sort((a,b)=>(a.priority??0)-(b.priority??0));
    html += `
      <div class="envHeader"><strong>Enveloppe :</strong> ${g.name}</div>
      <table class="table">
        <thead><tr><th>Projet</th><th class="right">Objectif</th><th class="right">√âpargn√©</th><th>Progression</th><th>Priorit√©</th><th></th></tr></thead>
        <tbody class="dropzone" data-env-id="${g.id}">
          ${items.map(p=>{
            const pct = p.target ? Math.min(100, Math.round((Number(p.saved||0)/Number(p.target))*100)) : 0;
            const status = (p.done || p.saved>=p.target) ? `<span class="success">Atteint ‚úÖ</span>` : `${pct}%`;
            return `
              <tr data-id="${p.id}" data-env-id="${p.envId}">
                <td>${p.name}</td>
                <td class="right">${fmt(p.target)}</td>
                <td class="right">${fmt(p.saved||0)}</td>
                <td>
                  <div class="bar"><i style="width:${pct}%"></i></div>
                  <div class="muted">${status}</div>
                </td>
                <td>
                  <div class="prio">
                    <button class="ghost" onclick="moveProject('${p.id}', -1)">‚¨ÜÔ∏è</button>
                    <button class="ghost" onclick="moveProject('${p.id}', 1)">‚¨áÔ∏è</button>
                  </div>
                  <div class="muted">rang: ${p.priority??0}</div>
                </td>
                <td class="right"><button class="danger" onclick="delProjet('${p.id}')">Suppr.</button></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;
  });

  $("projGroups").innerHTML = html;
  attachDnD();
}

function renderEpargne(){
  // s√©lecteur d‚Äôenveloppe pour cr√©er projet
  $("projEnv").innerHTML = SAV_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
  renderProjectsGrouped();
  renderProjection();
}

function renderAll(){
  $("nowMonth").textContent = new Date().toLocaleString("fr-DZ",{month:"long",year:"numeric"});
  renderBudget();
  renderEpargne();
}

/* ========= Boot ========= */
(function init(){
  // compat anciens projets : assigne des priorit√©s
  const envIds = [...new Set(PROJ.map(p=>p.envId))];
  envIds.forEach(ensurePriorities);
  renderAll();
})();
</script>
</body>
</html>
