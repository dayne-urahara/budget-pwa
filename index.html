<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Budget & √âpargne ‚Äî chiffrage + boussole</title>
<style>
  :root{
    --bg:#0b1020; --card:#0f162e; --ink:#e6e9f5; --muted:#a6b0cf; --ring:#24304f; --accent:#6ea8fe;
    --good:#22c55e; --bad:#ef4444; --warn:#f59e0b; --chip:#1b2441; --chip2:#10172a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0a0f1f,#0f1326);color:var(--ink)}
  header{position:sticky;top:0;z-index:20;background:rgba(10,15,31,.85);backdrop-filter:saturate(130%) blur(6px);border-bottom:1px solid #1a2240}
  .topbar{max-width:1280px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
  .logo{font-weight:700;letter-spacing:.3px}
  .tabs{display:flex;gap:8px;margin-left:auto}
  .tab{padding:10px 14px;border:1px solid var(--ring);border-radius:12px;background:var(--chip);color:var(--ink);cursor:pointer}
  .tab.active{background:var(--accent);color:#0b1020;border-color:transparent;font-weight:700}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:10px 0 16px}
  @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  .kpi{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:14px}
  .kpi h4{margin:0 0 6px 0;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.3px}
  .kpi .v{font-size:20px;font-weight:800}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width:1000px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px}
  h2{margin:0 0 10px 0;font-size:18px}
  h3{margin:10px 0 8px 0;font-size:16px}
  input,select,button{width:100%;padding:11px;border-radius:12px;border:1px solid var(--ring);font-size:15px;background:var(--chip2);color:var(--ink)}
  button.btn{border:none;background:var(--accent);color:#0b1020;font-weight:700;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1}
  .muted{color:var(--muted);font-size:14px}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{border-bottom:1px dashed #253154;padding:10px;text-align:left;vertical-align:top}
  .table thead th{color:var(--muted);font-size:13px}
  .right{text-align:right}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#10244a;color:#9ec1ff;font-size:12px;border:1px solid #22407c}
  .success{color:var(--good);font-weight:700}
  .danger{background:var(--bad);color:#fff;border:none;padding:7px 10px;border-radius:10px;cursor:pointer}
  .ghost{background:#182241;color:#e6e9f5;border:1px solid #2a3b6f;padding:6px 8px;border-radius:10px;cursor:pointer}
  .bar{height:8px;background:#1b2441;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,#5eead4,#60a5fa);width:0%}
  .hint{padding:10px;border-radius:12px;background:#0e1a38;border:1px dashed #223464;font-size:14px;color:#c5d2fb}
  .page{display:none}.page.active{display:block}
  .envHeader{background:#0e1a38;border:1px solid #223464;border-radius:12px;padding:12px;margin:14px 0 8px}
  .warn{color:var(--warn);font-weight:700}
  /* Drag & Drop */
  tbody.dropzone{border:1px dashed #2a3b6f;border-radius:12px}
  tr.dragging{opacity:.5}
  tr.drop-hint{outline:2px solid #6ea8fe}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="logo">üíé Budget & √âpargne</div>
    <div class="tabs">
      <button id="tabBudget" class="tab active" onclick="showPage('budget')">Budget</button>
      <button id="tabEpargne" class="tab" onclick="showPage('epargne')">√âpargne & Projets</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- KPIs toujours visibles -->
  <div class="kpis">
    <div class="kpi"><h4>Revenus (mois)</h4><div class="v" id="kpiRevenus">‚Äî</div></div>
    <div class="kpi"><h4>Budgets D√©penses (mois)</h4><div class="v" id="kpiBudgets">‚Äî</div></div>
    <div class="kpi"><h4>√âpargne vers√©e (mois)</h4><div class="v" id="kpiSav">‚Äî</div></div>
    <div class="kpi"><h4>Reste indicatif</h4><div class="v" id="kpiLeft">‚Äî</div></div>
  </div>

  <!-- PAGE: BUDGET -->
  <div id="budget" class="page active">
    <div class="grid">
      <div class="card">
        <h2>1) Revenus</h2>
        <div class="row">
          <input id="salaireInput" type="number" inputmode="decimal" placeholder="Salaire mensuel (DZD)"/>
          <button class="btn" onclick="saveSalaire()">Enregistrer</button>
        </div>
        <div class="row">
          <input id="revenuInput" type="number" inputmode="decimal" placeholder="Autre revenu ponctuel (DZD)"/>
          <button class="btn" onclick="addRevenu()">Ajouter revenu</button>
        </div>
        <p id="revenusInfo" class="muted"></p>
      </div>

      <div class="card">
        <h2>2) Enveloppes d‚Äô√âPARGNE</h2>
        <div class="row">
          <input id="savNom" placeholder="Nom (Am√©nagement, Voyage, S√©curit√©, Or‚Ä¶)"/>
          <button class="btn" onclick="addSavEnv()">Cr√©er enveloppe</button>
        </div>
        <table class="table">
          <thead><tr><th>Enveloppe</th><th class="right">Total vers√©</th><th class="right">Objectif mensuel</th><th></th></tr></thead>
          <tbody id="savBody"></tbody>
        </table>
        <p><span class="pill">Total √©pargne vers√©e : <span id="savTotal">0</span> DZD</span></p>

        <h3>Versement ‚Üí auto-r√©partition (respecte la priorit√© des projets)</h3>
        <div class="row">
          <select id="savSelect"></select>
          <input id="savVersement" type="number" inputmode="decimal" placeholder="Montant (DZD)"/>
          <button class="btn" onclick="verserEpargne()">Verser & r√©partir</button>
        </div>
        <p class="muted">Barre ci-dessous : √©pargne vers√©e en % des revenus.</p>
        <div class="bar"><i id="barSav"></i></div>
      </div>

      <div class="card">
        <h2>3) Enveloppes de D√âPENSES (facultatif)</h2>
        <div class="row">
          <input id="depNom" placeholder="Nom (Courses, V√©hicule, Scolaire‚Ä¶)"/>
          <input id="depMontant" type="number" inputmode="decimal" placeholder="Budget mensuel (DZD)"/>
          <button class="btn" onclick="addDepenseEnv()">Ajouter</button>
        </div>
        <table class="table">
          <thead><tr><th>Cat√©gorie</th><th class="right">Budget</th><th></th></tr></thead>
        <tbody id="depBody"></tbody>
        </table>
        <p><span class="pill">Total d√©penses budg√©t√©es : <span id="depTotal">0</span> DZD</span></p>
      </div>

      <div class="card">
        <h2>4) Export / Import des donn√©es (CHIFFR√â)</h2>
        <div class="row">
          <input id="expPass" type="password" placeholder="Mot de passe pour chiffrer l‚Äôexport"/>
          <button class="btn" onclick="exportEncrypted()">Exporter (AES-GCM)</button>
        </div>
        <div class="row">
          <input id="impPass" type="password" placeholder="Mot de passe de d√©chiffrement"/>
          <input id="impFile" type="file" accept=".json,application/json"/>
          <button class="btn" onclick="importEncrypted()">Importer</button>
        </div>
        <p class="muted">Format: PBKDF2(SHA-256, 250k iters) ‚Üí AES-GCM(256). Ne perds pas le mot de passe.</p>
      </div>
    </div>
  </div>

  <!-- PAGE: √âPARGNE & PROJETS -->
  <div id="epargne" class="page">
    <div class="card">
      <h2>Projets par enveloppe (drag & drop + priorit√©s)</h2>
      <div class="row">
        <select id="projEnv"></select>
        <input id="projNom" placeholder="Nom du projet (ex: Meuble salle de bain)"/>
      </div>
      <div class="row">
        <input id="projPrix" type="number" inputmode="decimal" placeholder="Objectif (DZD)"/>
        <button class="btn" onclick="addProjet()">Cr√©er projet</button>
      </div>
      <p class="muted">Glisse-d√©pose pour changer l‚Äôordre de financement. Le premier est servi en premier.</p>
      <div id="projGroups"></div>
    </div>

    <div class="card">
      <h2>Projection & Boussole</h2>
      <div class="row">
        <label class="muted">Moyenne mensuelle bas√©e sur :</label>
        <select id="avgMonths">
          <option value="3" selected>3 derniers mois</option>
          <option value="6">6 derniers mois</option>
          <option value="12">12 derniers mois</option>
        </select>
        <button class="btn" onclick="renderProjection()">Recalculer</button>
      </div>
      <div id="projectionWrap"></div>
      <div class="hint" id="compassBox">Conseils dynamiques‚Ä¶</div>
    </div>
  </div>
</div>

<script>
/* ========= State ========= */
const $ = id => document.getElementById(id);
const fmt = n => new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0))+" DZD";
const just = n => new Intl.NumberFormat("fr-DZ").format(Math.round(Number(n)||0));

let SALAIRE = Number(localStorage.getItem("SALAIRE")||0);
let REVENUS_SUPP = Number(localStorage.getItem("REVENUS_SUPP")||0);

// √âpargne ‚Äì enveloppes & versements
let SAV_ENV = JSON.parse(localStorage.getItem("SAV_ENV")||"[]");  // {id,name,totalIn,targetM}
let SAV_TX  = JSON.parse(localStorage.getItem("SAV_TX")||"[]");   // {id,date,envId,amount}

// Projets li√©s √† enveloppes (avec priority)
let PROJ    = JSON.parse(localStorage.getItem("PROJ")||"[]");     // {id,name,envId,target,saved,done,priority}
let PROJ_TX = JSON.parse(localStorage.getItem("PROJ_TX")||"[]");  // {id,date,projectId,amount,envId}

// D√©penses budg√©t√©es (facultatif)
let DEP_ENV = JSON.parse(localStorage.getItem("DEP_ENV")||"[]");  // {id,name,budget}

/* ========= Persist ========= */
function persist(){
  localStorage.setItem("SALAIRE",SALAIRE);
  localStorage.setItem("REVENUS_SUPP",REVENUS_SUPP);
  localStorage.setItem("SAV_ENV",JSON.stringify(SAV_ENV));
  localStorage.setItem("SAV_TX",JSON.stringify(SAV_TX));
  localStorage.setItem("PROJ",JSON.stringify(PROJ));
  localStorage.setItem("PROJ_TX",JSON.stringify(PROJ_TX));
  localStorage.setItem("DEP_ENV",JSON.stringify(DEP_ENV));
}

/* ========= Navigation ========= */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  $(id).classList.add("active");
  (id==="budget"?$("tabBudget"):$("tabEpargne")).classList.add("active");
}

/* ========= Calculs ========= */
function sumDepBudgets(){ return DEP_ENV.reduce((s,c)=>s+Number(c.budget||0),0); }
function totalRevenus(){ return (Number(SALAIRE)||0) + (Number(REVENUS_SUPP)||0); }
function totalSavAlloue(){ return SAV_ENV.reduce((s,e)=> s + Number(e.totalIn||0), 0); }

/* ========= Revenus ========= */
function saveSalaire(){
  const v = Number(($("salaireInput").value||0));
  if(!v){ alert("Salaire invalide."); return; }
  SALAIRE=v; $("salaireInput").value="";
  persist(); renderAll();
}
function addRevenu(){
  const v = Number(($("revenuInput").value||0));
  if(!v){ alert("Montant de revenu invalide."); return; }
  REVENUS_SUPP += v; $("revenuInput").value="";
  persist(); renderAll();
}

/* ========= √âpargne ‚Äì enveloppes ========= */
function addSavEnv(){
  const name = ($("savNom").value||"").trim();
  if(!name){ alert("Nom d‚Äôenveloppe requis."); return; }
  SAV_ENV.push({id:crypto.randomUUID(),name,totalIn:0,targetM:0});
  $("savNom").value="";
  persist(); renderAll();
}
function delSavEnv(id){
  // Supprime enveloppe + versements + projets & tx li√©s
  SAV_TX = SAV_TX.filter(t=>t.envId!==id);
  const projIds = PROJ.filter(p=>p.envId===id).map(p=>p.id);
  PROJ_TX = PROJ_TX.filter(x=> !projIds.includes(x.projectId));
  PROJ = PROJ.filter(p=>p.envId!==id);
  SAV_ENV = SAV_ENV.filter(e=>e.id!==id);
  persist(); renderAll();
}
function setEnvTarget(envId){
  const el = document.getElementById("targetM-"+envId);
  const v = Number((el?.value)||0);
  const env = SAV_ENV.find(e=>e.id===envId);
  if(!env) return;
  env.targetM = v>0 ? v : 0;
  persist(); renderAll();
}

/* ‚Äî Versement + auto-r√©partition selon priorit√© ‚Äî */
function ensurePriorities(envId){
  const ps = PROJ.filter(p=>p.envId===envId);
  ps.sort((a,b)=> (a.priority??Number.MAX_SAFE_INTEGER) - (b.priority??Number.MAX_SAFE_INTEGER));
  ps.forEach((p,i)=> p.priority=i);
}
function verserEpargne(){
  if(!SAV_ENV.length){ alert("Cr√©e d‚Äôabord une enveloppe d‚Äô√©pargne."); return; }
  const envId = $("savSelect").value;
  const amount = Number(($("savVersement").value||0));
  if(!amount){ alert("Montant invalide."); return; }

  const today = new Date().toISOString().slice(0,10);
  SAV_TX.push({id:crypto.randomUUID(),date:today,envId,amount});
  const env = SAV_ENV.find(e=>e.id===envId);
  env.totalIn = Number(env.totalIn||0) + amount;

  ensurePriorities(envId);
  let remain = amount;
  const list = PROJ
    .filter(p=>p.envId===envId && !p.done)
    .sort((a,b)=> (a.priority??0) - (b.priority??0));

  for(const p of list){
    if(remain<=0) break;
    const need = Math.max(0, Number(p.target||0) - Number(p.saved||0));
    if(need<=0){ p.done=true; continue; }
    const take = Math.min(need, remain);
    p.saved = Number(p.saved||0) + take;
    PROJ_TX.push({id:crypto.randomUUID(),date:today,projectId:p.id,amount:take,envId});
    if(p.saved >= p.target){ p.done = true; }
    remain -= take;
  }
  $("savVersement").value="";
  persist(); renderAll();
}

/* ========= Projets (cr√©ation + priorit√©s + drag & drop) ========= */
function getNextPriority(envId){
  const ps = PROJ.filter(p=>p.envId===envId);
  if(!ps.length) return 0;
  return Math.max(...ps.map(p=> (p.priority??0))) + 1;
}
function addProjet(){
  if(!SAV_ENV.length){ alert("Cr√©e d‚Äôabord une enveloppe d‚Äô√©pargne."); return; }
  const envId = $("projEnv").value;
  const name = ($("projNom").value||"").trim();
  const target = Number(($("projPrix").value||0));
  if(!name || !target){ alert("Nom et objectif requis."); return; }
  const prio = getNextPriority(envId);
  PROJ.push({id:crypto.randomUUID(),name,envId,target,saved:0,done:false,priority:prio});
  $("projNom").value=""; $("projPrix").value="";
  persist(); renderAll();
}
function delProjet(id){
  const envId = PROJ.find(p=>p.id===id)?.envId;
  PROJ = PROJ.filter(p=>p.id!==id);
  PROJ_TX = PROJ_TX.filter(t=>t.projectId!==id);
  if(envId) ensurePriorities(envId);
  persist(); renderAll();
}
function moveProject(id, dir){ // dir = -1 | +1
  const p = PROJ.find(x=>x.id===id); if(!p) return;
  ensurePriorities(p.envId);
  const sib = PROJ.filter(x=>x.envId===p.envId).sort((a,b)=>a.priority-b.priority);
  const idx = sib.findIndex(x=>x.id===id);
  const j = idx + dir; if (j<0 || j>=sib.length) return;
  const a=sib[idx], b=sib[j]; const tmp=a.priority; a.priority=b.priority; b.priority=tmp;
  persist(); renderAll();
}

/* ---- Drag & Drop intra-enveloppe ---- */
let dragState = { id:null, envId:null };
function attachDnD(){
  document.querySelectorAll('tbody.dropzone').forEach(tbody=>{
    tbody.addEventListener('dragover', (e)=>{ e.preventDefault(); const tr = e.target.closest('tr[data-id]'); if(tr) tr.classList.add('drop-hint'); });
    tbody.addEventListener('dragleave', (e)=>{ const tr = e.target.closest('tr[data-id]'); if(tr) tr.classList.remove('drop-hint'); });
    tbody.addEventListener('drop', (e)=>{
      e.preventDefault();
      const zone = e.currentTarget;
      if (!dragState.id || dragState.envId !== zone.dataset.envId) return;
      const rows = Array.from(zone.querySelectorAll('tr[data-id]'));
      rows.forEach(r=>r.classList.remove('drop-hint'));
      const targetRow = e.target.closest('tr[data-id]');
      const draggedId = dragState.id;
      const orderIds = rows.map(r=>r.dataset.id).filter(x=>x!==draggedId);
      if (targetRow) {
        const idx = rows.findIndex(r=>r===targetRow);
        orderIds.splice(idx, 0, draggedId);
      } else {
        orderIds.push(draggedId);
      }
      orderIds.forEach((pid, i)=>{ const p = PROJ.find(x=>x.id===pid); if (p) p.priority = i; });
      dragState.id=null; dragState.envId=null;
      persist(); renderAll();
    });
  });
  document.querySelectorAll('tr[data-id]').forEach(tr=>{
    tr.setAttribute('draggable','true');
    tr.addEventListener('dragstart', ()=>{
      tr.classList.add('dragging');
      dragState.id = tr.dataset.id;
      dragState.envId = tr.dataset.envId;
    });
    tr.addEventListener('dragend', ()=> tr.classList.remove('dragging'));
  });
}

/* ========= Projection & Boussole ========= */
function monthKeysBack(n){
  const arr=[]; const d=new Date();
  for(let i=0;i<n;i++){ const dd=new Date(d.getFullYear(), d.getMonth()-i, 1); arr.push(dd.toISOString().slice(0,7)); }
  return arr;
}
function avgMonthlyForEnv(envId, monthsWindow){
  const keys = monthKeysBack(monthsWindow);
  const sums = {}; keys.forEach(k=>sums[k]=0);
  for(const t of SAV_TX){
    if(t.envId!==envId) continue;
    const k = (t.date||"").slice(0,7);
    if (sums[k]!==undefined) sums[k] += Number(t.amount||0);
  }
  const total = keys.reduce((s,k)=> s + (sums[k]||0), 0);
  return total / keys.length;
}
function addMonths(d,n){ return new Date(d.getFullYear(), d.getMonth()+n, 1); }
function computeProjectionData(monthsWindow){
  const rowsByEnv={};
  for(const env of SAV_ENV){
    const avg = avgMonthlyForEnv(env.id, monthsWindow);
    const list = PROJ.filter(p=>p.envId===env.id).sort((a,b)=>(a.priority??0)-(b.priority??0));
    let cursor=0;
    rowsByEnv[env.id] = { name:env.name, avg, targetM:env.targetM||0, items:[] };
    for(const p of list){
      const remaining = Math.max(0, Number(p.target||0) - Number(p.saved||0));
      if (remaining===0){ rowsByEnv[env.id].items.push({project:p.name, remaining:0, months:0, eta:new Date(), done:true}); continue; }
      if (avg<=0){ rowsByEnv[env.id].items.push({project:p.name, remaining, months:Infinity, eta:null, done:false}); continue; }
      const mNeeded = Math.ceil(remaining / avg);
      cursor += mNeeded;
      rowsByEnv[env.id].items.push({project:p.name, remaining, months:mNeeded, eta:addMonths(new Date(), cursor), done:false});
    }
  }
  return rowsByEnv;
}
function renderProjection(){
  const win = Number(($("avgMonths").value||3));
  const byEnv = computeProjectionData(win);

  // tableau
  let html="";
  const ids = Object.keys(byEnv).sort((a,b)=> byEnv[a].name.localeCompare(byEnv[b].name));
  ids.forEach(id=>{
    const g = byEnv[id];
    html += `
      <div class="envHeader">
        <div class="row" style="align-items:center">
          <div style="flex:2"><strong>Enveloppe :</strong> ${g.name}</div>
          <div><span class="pill">Moyenne (${win}m) : ${fmt(g.avg||0)}</span></div>
          <div class="row" style="gap:6px;flex:1">
            <input id="targetM-${id}" placeholder="Objectif mensuel (DZD)" value="${SAV_ENV.find(e=>e.id===id)?.targetM||''}">
            <button class="btn" onclick="setEnvTarget('${id}')">Fixer objectif</button>
          </div>
        </div>
        <div class="muted">√âcart (moyenne ‚àí objectif) : <strong>${fmt((g.avg||0)-(SAV_ENV.find(e=>e.id===id)?.targetM||0))}</strong></div>
      </div>
      <table class="table">
        <thead><tr><th>Projet</th><th class="right">Restant</th><th class="right">Mois estim√©s</th><th>Date estim√©e</th><th>Statut</th></tr></thead>
        <tbody>
          ${
            g.items.map(it=>{
              const eta = it.eta ? it.eta.toLocaleString("fr-DZ",{year:"numeric", month:"long"}) : "‚Äî";
              let statut = "";
              if (it.done) statut = `<span class="success">Atteint ‚úÖ</span>`;
              else if (!isFinite(it.months)) statut = `<span class="warn">Aucun versement r√©cent</span>`;
              else statut = it.months<=12 ? `<span class="success">‚â§ 12 mois</span>` : `<span class="muted">> 12 mois</span>`;
              return `<tr>
                <td>${it.project}</td>
                <td class="right">${fmt(it.remaining)}</td>
                <td class="right">${isFinite(it.months)? it.months : "‚àû"}</td>
                <td>${eta}</td>
                <td>${statut}</td>
              </tr>`;
            }).join("")
          }
        </tbody>
      </table>
    `;
  });
  $("projectionWrap").innerHTML = html;

  // Boussole agressive
  const tips=[];
  // 1) √©quilibre global sur objectifs mensuels vs cash disponible
  const totalTargets = SAV_ENV.reduce((s,e)=> s + Number(e.targetM||0), 0);
  const cash = totalRevenus() - sumDepBudgets();
  if (totalTargets > cash){
    const gap = totalTargets - cash;
    tips.push(`<p class="warn">Tes objectifs mensuels d‚Äô√©pargne d√©passent ton cash disponible de <strong>${fmt(gap)}</strong>. 
    ‚Üí R√©duis tes budgets de d√©penses ou baisse provisoirement les objectifs d‚Äôenveloppes. 
    Reco rapide: diminuer chaque objectif de <strong>${fmt(Math.ceil(gap/Math.max(1,SAV_ENV.length)))}</strong>.</p>`);
  }
  // 2) enveloppes sans versement r√©cent
  const win = Number(($("avgMonths").value||3));
  const starving = SAV_ENV.filter(e=> (avgMonthlyForEnv(e.id, win)||0)===0 && PROJ.some(p=>p.envId===e.id && !p.done));
  if (starving.length){
    tips.push(`<p class="warn">Aucune moyenne de versement sur : ${starving.map(e=>`<strong>${e.name}</strong>`).join(", ")}. Fixe un minimum mensuel (ex: 5‚Äì10% des revenus).</p>`);
  }
  // 3) enveloppes o√π avg < targetM
  SAV_ENV.forEach(e=>{
    const avg = avgMonthlyForEnv(e.id, win)||0;
    const targ = Number(e.targetM||0);
    if (targ>0 && avg < targ){
      tips.push(`<p>Augmente <strong>${e.name}</strong> de <strong>${fmt(targ-avg)}</strong>/mois pour atteindre l‚Äôobjectif d√©fini.</p>`);
    }
  });
  // 4) projets > 12 mois ‚áí reco ‚Äúobjectif mensuel‚Äù env = somme restants / 12
  SAV_ENV.forEach(e=>{
    const list = PROJ.filter(p=>p.envId===e.id);
    const sumRemaining = list.reduce((s,p)=> s + Math.max(0, Number(p.target||0)-Number(p.saved||0)), 0);
    if (sumRemaining>0){
      const needPerMonth = Math.ceil(sumRemaining/12);
      const avg = avgMonthlyForEnv(e.id, win)||0;
      if (avg < needPerMonth){
        tips.push(`<p>${e.name}: pour boucler <em>tous</em> les projets ‚â§ 12 mois, vise <strong>${fmt(needPerMonth)}</strong>/mois (actuel: ${fmt(avg)}).</p>`);
      }
    }
  });
  if (!tips.length){
    tips.push(`<p class="success">Cap OK : tes objectifs sont soutenables avec tes versements actuels.</p>`);
  }
  $("compassBox").innerHTML = tips.join("");
}

/* ========= Rendering ========= */
function renderBudget(){
  const revenus = totalRevenus();
  const budgets = sumDepBudgets();
  const sav = totalSavAlloue();
  const left = Math.max(0, revenus - budgets - sav);

  $("kpiRevenus").textContent = fmt(revenus);
  $("kpiBudgets").textContent = fmt(budgets);
  $("kpiSav").textContent = fmt(sav);
  $("kpiLeft").textContent = fmt(left);

  $("revenusInfo").innerHTML = `üí∞ Salaire : ${fmt(SALAIRE)} ‚Ä¢ ‚ûï Revenus sup. : ${fmt(REVENUS_SUPP)} ‚Ä¢ üìä Total : ${fmt(revenus)}`;

  // √âpargne ‚Äì enveloppes
  $("savBody").innerHTML = SAV_ENV.map(e=>{
    const t = e.targetM||0;
    return `
      <tr>
        <td>${e.name}</td>
        <td class="right">${fmt(e.totalIn||0)}</td>
        <td class="right">${t?fmt(t):"<span class='muted'>‚Äî</span>"}</td>
        <td class="right"><button class="danger" onclick="delSavEnv('${e.id}')">Suppr.</button></td>
      </tr>
    `;
  }).join("");
  $("savTotal").textContent = just(totalSavAlloue());
  $("savSelect").innerHTML = SAV_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");

  // D√©penses budg√©t√©es
  $("depBody").innerHTML = DEP_ENV.map(e=>`
    <tr>
      <td>${e.name}</td>
      <td class="right">${fmt(e.budget||0)}</td>
      <td class="right"><button class="danger" onclick="delDepenseEnv('${e.id}')">Suppr.</button></td>
    </tr>
  `).join("");
  $("depTotal").textContent = just(sumDepBudgets());

  // barre % √©pargne / revenus
  const ratio = revenus ? Math.min(100, Math.round((sav/revenus)*100)) : 0;
  $("barSav").style.width = ratio + "%";

  // s√©lecteurs
  $("projEnv").innerHTML = SAV_ENV.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
}

/* --- Projets group√©s + DnD --- */
function renderProjectsGrouped(){
  const groups = {};
  for(const e of SAV_ENV){ groups[e.id] = { name:e.name, id:e.id, items:[] }; }
  for(const p of PROJ){ if(groups[p.envId]) groups[p.envId].items.push(p); }

  let html = "";
  const envIds = Object.keys(groups).sort((a,b)=> groups[a].name.localeCompare(groups[b].name));
  envIds.forEach(envId=>{
    // normalise priorit√©s
    ensurePriorities(envId);
    const g = groups[envId];
    const items = g.items.slice().sort((a,b)=>(a.priority??0)-(b.priority??0));
    html += `
      <div class="envHeader"><strong>Enveloppe :</strong> ${g.name}</div>
      <table class="table">
        <thead><tr><th>Projet</th><th class="right">Objectif</th><th class="right">√âpargn√©</th><th>Progression</th><th>Priorit√©</th><th></th></tr></thead>
        <tbody class="dropzone" data-env-id="${g.id}">
          ${items.map(p=>{
            const pct = p.target ? Math.min(100, Math.round((Number(p.saved||0)/Number(p.target))*100)) : 0;
            const status = (p.done || p.saved>=p.target) ? `<span class="success">Atteint ‚úÖ</span>` : `${pct}%`;
            return `
              <tr data-id="${p.id}" data-env-id="${p.envId}">
                <td>${p.name}</td>
                <td class="right">${fmt(p.target)}</td>
                <td class="right">${fmt(p.saved||0)}</td>
                <td>
                  <div class="bar"><i style="width:${pct}%"></i></div>
                  <div class="muted">${status}</div>
                </td>
                <td>
                  <div class="row" style="gap:6px">
                    <button class="ghost" onclick="moveProject('${p.id}', -1)">‚¨ÜÔ∏è</button>
                    <button class="ghost" onclick="moveProject('${p.id}', 1)">‚¨áÔ∏è</button>
                  </div>
                  <div class="muted">rang: ${p.priority??0}</div>
                </td>
                <td class="right"><button class="danger" onclick="delProjet('${p.id}')">Suppr.</button></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;
  });

  $("projGroups").innerHTML = html;
  attachDnD();
}

function renderEpargne(){
  renderProjectsGrouped();
  renderProjection();
}

function renderAll(){
  renderBudget();
  renderEpargne();
}

/* ========= Export / Import CHIFFR√â ========= */
// Utils b64
function b64enc(buf){
  const bytes = buf instanceof Uint8Array ? buf : new Uint8Array(buf);
  let bin=""; for(let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin);
}
function b64dec(b64){
  const bin = atob(b64);
  const len = bin.length;
  const bytes = new Uint8Array(len);
  for(let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
  return bytes;
}

async function deriveKey(pass, salt, iterations=250000){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
  return await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations, hash:'SHA-256'},
    baseKey,
    {name:'AES-GCM', length:256},
    false,
    ['encrypt','decrypt']
  );
}

async function exportEncrypted(){
  try{
    const pass = ($("expPass").value||"").trim();
    if(!pass){ alert("Entre un mot de passe pour chiffrer."); return; }
    const data = { SALAIRE, REVENUS_SUPP, SAV_ENV, SAV_TX, PROJ, PROJ_TX, DEP_ENV };
    const enc = new TextEncoder().encode(JSON.stringify(data));
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await deriveKey(pass, salt, 250000);
    const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc);
    const payload = {
      v:1, alg:'AES-GCM', kdf:'PBKDF2', iter:250000,
      salt: b64enc(salt), iv: b64enc(iv), ct: b64enc(ct)
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download=`budget-secure-${new Date().toISOString().slice(0,10)}.json`;
    a.click(); URL.revokeObjectURL(url);
    alert("Export chiffr√© OK.");
  }catch(e){
    alert("√âchec export: " + e.message);
  }
}

async function importEncrypted(){
  try{
    const pass = ($("impPass").value||"").trim();
    const file = $("impFile").files?.[0];
    if(!pass){ alert("Entre le mot de passe de d√©chiffrement."); return; }
    if(!file){ alert("Choisis le fichier export√©."); return; }
    const text = await file.text();
    const payload = JSON.parse(text);
    const salt = b64dec(payload.salt);
    const iv = b64dec(payload.iv);
    const ct = b64dec(payload.ct);
    const key = await deriveKey(pass, salt, payload.iter||250000);
    const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
    const json = JSON.parse(new TextDecoder().decode(pt));
    // charger
    SALAIRE = Number(json.SALAIRE||0);
    REVENUS_SUPP = Number(json.REVENUS_SUPP||0);
    SAV_ENV = Array.isArray(json.SAV_ENV)? json.SAV_ENV : [];
    SAV_TX = Array.isArray(json.SAV_TX)? json.SAV_TX : [];
    PROJ = Array.isArray(json.PROJ)? json.PROJ : [];
    PROJ_TX = Array.isArray(json.PROJ_TX)? json.PROJ_TX : [];
    DEP_ENV = Array.isArray(json.DEP_ENV)? json.DEP_ENV : [];
    persist(); renderAll();
    alert("Import d√©chiffr√© OK.");
  }catch(e){
    alert("√âchec import (mot de passe ? fichier ?) : " + e.message);
  }
}

/* ========= Boot ========= */
(function init(){
  // compat anciennes donn√©es
  for(const e of SAV_ENV){ if(e.targetM===undefined) e.targetM = 0; }
  renderAll();
})();
</script>
</body>
</html>
